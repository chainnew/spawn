# spawn.new WebVM Dockerfile
# Custom Debian image optimized for web development
# Based on: https://github.com/chainnew/webvm
#
# To use: Copy to your webvm fork's dockerfiles/ directory
# Then run the Deploy workflow with "Path to Dockerfile" = dockerfiles/spawn_dev

FROM --platform=i386 i386/debian:bookworm

ARG DEBIAN_FRONTEND=noninteractive

# Base system + build tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Core utilities
    bash \
    curl \
    wget \
    ca-certificates \
    git \
    vim \
    nano \
    less \
    htop \
    tree \
    unzip \
    jq \
    # Build essentials
    build-essential \
    pkg-config \
    libssl-dev \
    # Python
    python3 \
    python3-pip \
    python3-venv \
    python3-dev \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js 20.x (LTS)
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Install pnpm globally
RUN npm install -g pnpm@latest

# Install useful global npm packages
RUN npm install -g \
    typescript \
    tsx \
    vite \
    eslint \
    prettier

# Create user
RUN useradd -m -s /bin/bash user \
    && echo 'user:user' | chpasswd

# Switch to user for Rust install
USER user
WORKDIR /home/user

# Install Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable --profile minimal
ENV PATH="/home/user/.cargo/bin:${PATH}"

# Create workspace directory
RUN mkdir -p /home/user/workspace

# Setup bashrc with spawn.new theme
RUN cat >> /home/user/.bashrc << 'EOF'

# spawn.new environment
export PS1='\[\033[01;36m\]spawn\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
export PATH="$HOME/.cargo/bin:$HOME/.local/bin:$PATH"
export EDITOR=vim

# Aliases
alias ll='ls -la --color=auto'
alias ws='cd ~/workspace'
alias p='pnpm'
alias pd='pnpm dev'
alias pi='pnpm install'
alias gs='git status'

# Welcome
echo ""
echo "  âš¡ spawn.new sandbox"
echo "  ðŸ“ ~/workspace  â€¢  node $(node -v)  â€¢  pnpm $(pnpm -v)"
echo ""
EOF

WORKDIR /home/user

ENV HOME="/home/user" \
    TERM="xterm-256color" \
    USER="user" \
    SHELL="/bin/bash" \
    LANG="en_US.UTF-8" \
    LC_ALL="C" \
    PATH="/home/user/.cargo/bin:/home/user/.local/bin:/usr/local/bin:/usr/bin:/bin"

CMD ["/bin/bash", "-l"]
