# Spawn Agent Stack - Podman Compose
# Run with: podman-compose up -d

version: "3.9"

services:
  # ==============================================
  # Spawn Agent Sandbox (Grok + Tools)
  # ==============================================
  agent:
    build:
      context: ..
      dockerfile: containers/Containerfile.agent
    image: spawn-agent:latest
    container_name: spawn-agent
    restart: unless-stopped
    ports:
      - "3081:3080"
    environment:
      - NODE_ENV=production
      - PORT=3080
      - WORKSPACE_PATH=/home/agent/workspace
      # API Keys (set in .env file)
      - XAI_API_KEY=${XAI_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
    volumes:
      - agent-workspace:/home/agent/workspace
      - ./logs:/app/logs
    networks:
      - spawn-net
    # Security: Drop all caps, no new privs
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - redis

  # ==============================================
  # Redis (Session store, caching, pub/sub)
  # ==============================================
  redis:
    image: docker.io/library/redis:7-alpine
    container_name: spawn-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - spawn-net
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ==============================================
  # PostgreSQL (Persistent storage)
  # ==============================================
  postgres:
    image: docker.io/library/postgres:16-alpine
    container_name: spawn-postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: spawn
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-spawn_dev_password}
      POSTGRES_DB: spawn
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - spawn-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U spawn"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==============================================
  # Caddy (Reverse proxy + HTTPS)
  # ==============================================
  caddy:
    image: docker.io/library/caddy:2-alpine
    container_name: spawn-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    networks:
      - spawn-net
    depends_on:
      - agent

# ==============================================
# Networks
# ==============================================
networks:
  spawn-net:
    driver: bridge

# ==============================================
# Volumes
# ==============================================
volumes:
  agent-workspace:
    name: spawn-agent-workspace
  redis-data:
    name: spawn-redis-data
  postgres-data:
    name: spawn-postgres-data
  caddy-data:
    name: spawn-caddy-data
  caddy-config:
    name: spawn-caddy-config
