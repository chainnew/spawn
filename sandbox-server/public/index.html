<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spawn Sandbox - Grok + Tools</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            spawn: { bg: '#0a0a0a', surface: '#141414', border: '#262626', accent: '#a855f7', text: '#e5e5e5', muted: '#737373' }
          }
        }
      }
    }
  </script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; background: #0a0a0a; color: #e5e5e5; font-family: system-ui, -apple-system, sans-serif; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #141414; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #444; }
    .typing-cursor::after { content: 'â–‹'; animation: blink 1s infinite; }
    @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
    pre { margin: 0; white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ==================== Artifact Renderer ====================
    const escapeHTML = (str = '') => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

    const generators = {
      react: (code) => `<!DOCTYPE html><html><head>
<meta charset="UTF-8" />
<script src="https://cdn.tailwindcss.com"><\/script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"><\/script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"><\/script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"><\/script>
<script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"><\/script>
<style>body { margin: 0; padding: 16px; font-family: system-ui; background: #0f0f0f; color: white; } .err { padding: 12px; background: #7f1d1d; color: #fca5a5; border-radius: 8px; }</style>
</head><body><div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback, useMemo } = React;
const { LineChart, Line, BarChart, Bar, AreaChart, Area, PieChart, Pie, Cell, XAxis, YAxis, Tooltip, Legend, CartesianGrid, ResponsiveContainer } = Recharts || {};
class ErrorBoundary extends React.Component {
  constructor(p) { super(p); this.state = { error: null }; }
  static getDerivedStateFromError(error) { return { error }; }
  render() { return this.state.error ? <div className="err">{this.state.error.message}</div> : this.props.children; }
}
try {
  ${code}
  const RootComponent = typeof App !== 'undefined' ? App : () => <div className="err">No App component</div>;
  ReactDOM.createRoot(document.getElementById('root')).render(<ErrorBoundary><RootComponent /></ErrorBoundary>);
  parent.postMessage({ type: 'ready' }, '*');
} catch (err) {
  document.getElementById('root').innerHTML = '<div class="err">' + err.message + '</div>';
}
new ResizeObserver(() => parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*')).observe(document.body);
<\/script></body></html>`,

      html: (code) => `<!DOCTYPE html><html><head>
<meta charset="UTF-8" /><script src="https://cdn.tailwindcss.com"><\/script>
<style>body { margin: 0; padding: 16px; font-family: system-ui; background: #0f0f0f; color: white; }</style>
</head><body>${code}
<script>parent.postMessage({ type: 'ready' }, '*'); new ResizeObserver(() => parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*')).observe(document.body);<\/script>
</body></html>`,

      mermaid: (code) => `<!DOCTYPE html><html><head>
<meta charset="UTF-8" /><script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"><\/script>
<style>body { margin: 0; padding: 16px; display: flex; justify-content: center; background: #0f0f0f; }</style>
</head><body><div class="mermaid">${code}</div>
<script>mermaid.initialize({ startOnLoad: true, theme: 'dark' }); mermaid.run().then(() => { parent.postMessage({ type: 'ready' }, '*'); parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*'); });<\/script>
</body></html>`,

      markdown: (code) => `<!DOCTYPE html><html><head>
<meta charset="UTF-8" /><script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"><\/script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5/github-markdown-dark.min.css">
<style>body { margin: 0; padding: 16px; background: #0f0f0f; } .markdown-body { background: transparent; }</style>
</head><body><div id="c" class="markdown-body"></div>
<script>document.getElementById('c').innerHTML = marked.parse(\`${code.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`); parent.postMessage({ type: 'ready' }, '*'); parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*');<\/script>
</body></html>`,

      svg: (code) => `<!DOCTYPE html><html><head>
<style>body { margin: 0; padding: 16px; display: flex; justify-content: center; background: #0f0f0f; }</style>
</head><body>${code}<script>parent.postMessage({ type: 'ready' }, '*');<\/script></body></html>`,

      code: (code, lang) => `<!DOCTYPE html><html><head>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css">
<script src="https://cdn.jsdelivr.net/npm/prismjs@1/prism.min.js"><\/script>
<style>body { margin: 0; background: #1e1e1e; } pre { margin: 0; padding: 16px; } code { font-family: 'JetBrains Mono', monospace; font-size: 13px; }</style>
</head><body><pre><code class="language-${lang || 'javascript'}">${escapeHTML(code)}</code></pre>
<script>Prism.highlightAll(); parent.postMessage({ type: 'ready' }, '*');<\/script></body></html>`,
    };

    function ArtifactPreview({ artifact }) {
      const iframeRef = useRef(null);
      const [height, setHeight] = useState(300);

      useEffect(() => {
        const handler = (e) => {
          if (e.source !== iframeRef.current?.contentWindow) return;
          if (e.data.type === 'resize') setHeight(Math.max(200, e.data.height + 20));
        };
        window.addEventListener('message', handler);
        return () => window.removeEventListener('message', handler);
      }, []);

      useEffect(() => {
        if (!iframeRef.current || !artifact) return;
        const gen = generators[artifact.type] || generators.html;
        iframeRef.current.srcdoc = gen(artifact.content, artifact.lang);
      }, [artifact]);

      return (
        <div className="border border-spawn-border rounded-lg overflow-hidden bg-[#0f0f0f]">
          <div className="h-8 bg-spawn-surface flex items-center justify-between px-3 border-b border-spawn-border">
            <div className="flex items-center gap-2">
              <span className="text-xs px-1.5 py-0.5 bg-purple-600/20 text-purple-400 rounded uppercase">{artifact.type}</span>
              <span className="text-sm text-white">{artifact.title}</span>
            </div>
          </div>
          <iframe ref={iframeRef} className="w-full border-0" style={{ height }} sandbox="allow-scripts allow-same-origin" />
        </div>
      );
    }

    // ==================== Message Components ====================
    function ToolCallDisplay({ tool, args, result }) {
      const [expanded, setExpanded] = useState(false);
      const isSuccess = result?.success !== false;

      return (
        <div className="my-2 border border-spawn-border rounded-lg overflow-hidden bg-spawn-bg/50">
          <button
            onClick={() => setExpanded(!expanded)}
            className="w-full flex items-center justify-between px-3 py-2 hover:bg-spawn-surface/50 transition-colors"
          >
            <div className="flex items-center gap-2">
              <span className={`w-2 h-2 rounded-full ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`} />
              <span className="text-xs font-mono text-purple-400">{tool}</span>
              <span className="text-xs text-spawn-muted truncate max-w-xs">
                {JSON.stringify(args).slice(0, 60)}...
              </span>
            </div>
            <span className="text-spawn-muted">{expanded ? 'â–¼' : 'â–¶'}</span>
          </button>
          {expanded && (
            <div className="p-3 border-t border-spawn-border bg-[#0a0a0a]">
              <div className="text-xs text-spawn-muted mb-1">Arguments:</div>
              <pre className="text-xs text-green-400 mb-3 overflow-auto max-h-32">{JSON.stringify(args, null, 2)}</pre>
              <div className="text-xs text-spawn-muted mb-1">Result:</div>
              <pre className="text-xs text-cyan-400 overflow-auto max-h-48">{JSON.stringify(result, null, 2)}</pre>
            </div>
          )}
        </div>
      );
    }

    function Message({ message }) {
      const isUser = message.role === 'user';
      const isSystem = message.role === 'system';

      if (isSystem) return null;

      return (
        <div className={`flex gap-3 ${isUser ? 'flex-row-reverse' : ''}`}>
          <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${
            isUser ? 'bg-blue-600' : 'bg-purple-600'
          }`}>
            {isUser ? 'ðŸ‘¤' : 'ðŸ¤–'}
          </div>
          <div className={`flex-1 max-w-[80%] ${isUser ? 'text-right' : ''}`}>
            <div className={`inline-block rounded-2xl px-4 py-2 ${
              isUser ? 'bg-blue-600 text-white' : 'bg-spawn-surface text-spawn-text'
            }`}>
              <p className="text-sm whitespace-pre-wrap">{message.content}</p>
            </div>

            {/* Tool calls */}
            {message.toolCalls?.map((tc, i) => (
              <ToolCallDisplay key={i} {...tc} />
            ))}

            {/* Artifacts */}
            {message.artifacts?.map((artifact, i) => (
              <div key={i} className="mt-3">
                <ArtifactPreview artifact={artifact} />
              </div>
            ))}

            {message.timestamp && (
              <div className="text-xs text-spawn-muted mt-1">
                {new Date(message.timestamp).toLocaleTimeString()}
              </div>
            )}
          </div>
        </div>
      );
    }

    // ==================== Main App ====================
    function App() {
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const [loading, setLoading] = useState(false);
      const [thinking, setThinking] = useState('');
      const [serverStatus, setServerStatus] = useState(null);
      const messagesEndRef = useRef(null);
      const inputRef = useRef(null);

      // Check server health
      useEffect(() => {
        fetch('/health')
          .then(r => r.json())
          .then(setServerStatus)
          .catch(() => setServerStatus({ status: 'offline' }));
      }, []);

      // Auto-scroll
      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages, thinking]);

      // Send message
      const sendMessage = async () => {
        if (!input.trim() || loading) return;

        const userMessage = {
          role: 'user',
          content: input.trim(),
          timestamp: new Date(),
        };

        setMessages(prev => [...prev, userMessage]);
        setInput('');
        setLoading(true);
        setThinking('Thinking...');

        try {
          // Use streaming endpoint
          const response = await fetch('/api/chat/stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message: userMessage.content,
              history: messages.slice(-10).map(m => ({ role: m.role, content: m.content })),
            }),
          });

          const reader = response.body.getReader();
          const decoder = new TextDecoder();

          let assistantMessage = {
            role: 'assistant',
            content: '',
            toolCalls: [],
            artifacts: [],
            timestamp: new Date(),
          };

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n').filter(l => l.startsWith('data: '));

            for (const line of lines) {
              try {
                const data = JSON.parse(line.slice(6));

                switch (data.type) {
                  case 'thinking':
                    setThinking(`Thinking... (step ${data.iteration})`);
                    break;
                  case 'tool_start':
                    setThinking(`Running ${data.tool}...`);
                    break;
                  case 'tool_result':
                    assistantMessage.toolCalls.push({
                      tool: data.tool,
                      args: data.args,
                      result: data.result,
                    });
                    setMessages(prev => [...prev.slice(0, -1), { ...assistantMessage }]);
                    break;
                  case 'artifact':
                    assistantMessage.artifacts.push(data.artifact);
                    setMessages(prev => {
                      const updated = [...prev];
                      if (updated[updated.length - 1]?.role === 'assistant') {
                        updated[updated.length - 1] = { ...assistantMessage };
                      }
                      return updated;
                    });
                    break;
                  case 'response':
                    assistantMessage.content = data.content;
                    setMessages(prev => {
                      const updated = [...prev];
                      const lastIdx = updated.length - 1;
                      if (updated[lastIdx]?.role === 'assistant') {
                        updated[lastIdx] = { ...assistantMessage };
                      } else {
                        updated.push({ ...assistantMessage });
                      }
                      return updated;
                    });
                    break;
                  case 'done':
                    setThinking('');
                    break;
                  case 'error':
                    setThinking('');
                    assistantMessage.content = `Error: ${data.message}`;
                    setMessages(prev => [...prev, { ...assistantMessage }]);
                    break;
                }
              } catch {}
            }
          }

          // Ensure final message is added
          if (assistantMessage.content || assistantMessage.toolCalls.length || assistantMessage.artifacts.length) {
            setMessages(prev => {
              const updated = [...prev];
              const lastIdx = updated.length - 1;
              if (updated[lastIdx]?.role !== 'assistant') {
                updated.push({ ...assistantMessage });
              }
              return updated;
            });
          }

        } catch (err) {
          setMessages(prev => [...prev, {
            role: 'assistant',
            content: `Error: ${err.message}`,
            timestamp: new Date(),
          }]);
        } finally {
          setLoading(false);
          setThinking('');
          inputRef.current?.focus();
        }
      };

      const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      };

      return (
        <div className="h-screen flex flex-col bg-spawn-bg">
          {/* Header */}
          <header className="h-12 border-b border-spawn-border flex items-center justify-between px-4 bg-spawn-surface flex-shrink-0">
            <div className="flex items-center gap-3">
              <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center text-lg">
                ðŸ§ 
              </div>
              <div>
                <span className="font-semibold text-white">Spawn Sandbox</span>
                <span className="ml-2 text-xs px-2 py-0.5 rounded-full bg-green-600/20 text-green-400">Grok + Tools</span>
              </div>
            </div>
            <div className="flex items-center gap-3">
              <div className={`w-2 h-2 rounded-full ${serverStatus?.running ? 'bg-green-500' : 'bg-red-500'}`} />
              <span className="text-xs text-spawn-muted">{serverStatus?.container || 'Checking...'}</span>
            </div>
          </header>

          {/* Messages */}
          <div className="flex-1 overflow-auto p-4 space-y-4">
            {messages.length === 0 && (
              <div className="text-center py-12">
                <div className="text-4xl mb-4">ðŸ¤–</div>
                <h2 className="text-xl font-semibold text-white mb-2">Grok Sandbox</h2>
                <p className="text-spawn-muted max-w-md mx-auto">
                  I can execute commands, write code, clone repos, and create visual artifacts.
                  Try asking me to build something!
                </p>
                <div className="mt-6 flex flex-wrap gap-2 justify-center">
                  {[
                    'Create a React counter with animations',
                    'Show me the files in /workspace',
                    'Clone https://github.com/denoland/fresh',
                    'Create a mermaid diagram of a microservices architecture',
                  ].map((prompt, i) => (
                    <button
                      key={i}
                      onClick={() => { setInput(prompt); inputRef.current?.focus(); }}
                      className="px-3 py-1.5 bg-spawn-surface hover:bg-spawn-border text-sm text-spawn-text rounded-lg transition-colors"
                    >
                      {prompt}
                    </button>
                  ))}
                </div>
              </div>
            )}

            {messages.map((msg, i) => (
              <Message key={i} message={msg} />
            ))}

            {thinking && (
              <div className="flex gap-3">
                <div className="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center flex-shrink-0">
                  ðŸ¤–
                </div>
                <div className="bg-spawn-surface rounded-2xl px-4 py-2">
                  <p className="text-sm text-spawn-muted typing-cursor">{thinking}</p>
                </div>
              </div>
            )}

            <div ref={messagesEndRef} />
          </div>

          {/* Input */}
          <div className="border-t border-spawn-border p-4 bg-spawn-surface flex-shrink-0">
            <div className="flex gap-3 max-w-4xl mx-auto">
              <textarea
                ref={inputRef}
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyDown={handleKeyDown}
                placeholder="Ask Grok to build something..."
                className="flex-1 bg-spawn-bg border border-spawn-border rounded-xl px-4 py-3 text-sm text-white placeholder-spawn-muted resize-none focus:outline-none focus:border-purple-600 transition-colors"
                rows={2}
                disabled={loading}
              />
              <button
                onClick={sendMessage}
                disabled={loading || !input.trim()}
                className="px-6 bg-purple-600 hover:bg-purple-500 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-xl font-medium transition-colors"
              >
                {loading ? '...' : 'Send'}
              </button>
            </div>
            <div className="text-xs text-spawn-muted text-center mt-2">
              Press Enter to send, Shift+Enter for new line
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
