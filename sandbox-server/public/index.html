<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ARCHITECT â€” AI Development Agent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            spawn: { bg: '#0a0a0a', surface: '#141414', border: '#262626', accent: '#a855f7', text: '#e5e5e5', muted: '#737373' }
          }
        }
      }
    }
  </script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; overflow: hidden; }
    html { font-size: 14px; }
    body { margin: 0; background: #0a0a0a; color: #e5e5e5; font-family: system-ui, -apple-system, sans-serif; zoom: 0.85; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #0a0a0a; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #444; }

    /* Hide scrollbar on chat messages */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    pre { margin: 0; white-space: pre-wrap; word-break: break-word; }

    /* Spinner animations */
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
    .animate-spin { animation: spin 1s linear infinite; }
    .animate-pulse { animation: pulse 2s ease-in-out infinite; }

    /* Ellipsis spinner dots */
    .dot-1 { animation: bounce 0.6s ease-in-out infinite; animation-delay: 0s; }
    .dot-2 { animation: bounce 0.6s ease-in-out infinite; animation-delay: 0.1s; }
    .dot-3 { animation: bounce 0.6s ease-in-out infinite; animation-delay: 0.2s; }

    /* Text auto-resize */
    .auto-resize-textarea {
      resize: none;
      overflow: hidden;
      min-height: 56px;
      max-height: 200px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ==================== Spinner Components ====================
    const SpinnerCircle = ({ size = 20, className = '' }) => (
      <svg className={`animate-spin ${className}`} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="12" cy="12" r="10" strokeWidth="3" strokeOpacity="0.2" />
        <path d="M12 2a10 10 0 0 1 10 10" strokeWidth="3" strokeLinecap="round" />
      </svg>
    );

    const SpinnerEllipsis = ({ size = 24, className = '' }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" className={className}>
        <circle className="dot-1" cx="4" cy="12" r="2.5" fill="currentColor" />
        <circle className="dot-2" cx="12" cy="12" r="2.5" fill="currentColor" />
        <circle className="dot-3" cx="20" cy="12" r="2.5" fill="currentColor" />
      </svg>
    );

    const SpinnerRing = ({ size = 24, className = '' }) => (
      <svg width={size} height={size} viewBox="0 0 44 44" stroke="currentColor" className={className}>
        <g fill="none" fillRule="evenodd" strokeWidth="2">
          <circle cx="22" cy="22" r="1">
            <animate attributeName="r" begin="0s" dur="1.8s" values="1; 20" calcMode="spline" keyTimes="0; 1" keySplines="0.165, 0.84, 0.44, 1" repeatCount="indefinite" />
            <animate attributeName="stroke-opacity" begin="0s" dur="1.8s" values="1; 0" calcMode="spline" keyTimes="0; 1" keySplines="0.3, 0.61, 0.355, 1" repeatCount="indefinite" />
          </circle>
          <circle cx="22" cy="22" r="1">
            <animate attributeName="r" begin="-0.9s" dur="1.8s" values="1; 20" calcMode="spline" keyTimes="0; 1" keySplines="0.165, 0.84, 0.44, 1" repeatCount="indefinite" />
            <animate attributeName="stroke-opacity" begin="-0.9s" dur="1.8s" values="1; 0" calcMode="spline" keyTimes="0; 1" keySplines="0.3, 0.61, 0.355, 1" repeatCount="indefinite" />
          </circle>
        </g>
      </svg>
    );

    const SpinnerInfinite = ({ size = 24, className = '' }) => (
      <svg width={size} height={size} viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" className={className}>
        <path
          fill="none"
          stroke="currentColor"
          strokeWidth="8"
          strokeDasharray="205 51"
          d="M24.3 30C11.4 30 5 43.3 5 50s6.4 20 19.3 20c19.3 0 32.1-40 51.4-40 C88.6 30 95 43.3 95 50s-6.4 20-19.3 20C56.4 70 43.6 30 24.3 30z"
          strokeLinecap="round"
          style={{ transform: 'scale(0.8)', transformOrigin: '50px 50px' }}
        >
          <animate attributeName="stroke-dashoffset" repeatCount="indefinite" dur="2s" keyTimes="0;1" values="0;256.58892822265625" />
        </path>
      </svg>
    );

    // ==================== Artifact Renderer ====================
    const escapeHTML = (str = '') => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

    // Language icons and colors for code display
    const langMeta = {
      python: { icon: 'ðŸ', color: '#3776ab', name: 'Python' },
      javascript: { icon: 'ðŸŸ¨', color: '#f7df1e', name: 'JavaScript' },
      typescript: { icon: 'ðŸ”·', color: '#3178c6', name: 'TypeScript' },
      rust: { icon: 'ðŸ¦€', color: '#dea584', name: 'Rust' },
      go: { icon: 'ðŸ”µ', color: '#00add8', name: 'Go' },
      java: { icon: 'â˜•', color: '#ed8b00', name: 'Java' },
      cpp: { icon: 'âš¡', color: '#00599c', name: 'C++' },
      c: { icon: 'ðŸ”§', color: '#555555', name: 'C' },
      html: { icon: 'ðŸŒ', color: '#e34f26', name: 'HTML' },
      css: { icon: 'ðŸŽ¨', color: '#1572b6', name: 'CSS' },
      sql: { icon: 'ðŸ—„ï¸', color: '#336791', name: 'SQL' },
      bash: { icon: 'ðŸ’»', color: '#4eaa25', name: 'Bash' },
      shell: { icon: 'ðŸ’»', color: '#4eaa25', name: 'Shell' },
      json: { icon: 'ðŸ“‹', color: '#292929', name: 'JSON' },
      yaml: { icon: 'ðŸ“', color: '#cb171e', name: 'YAML' },
      toml: { icon: 'âš™ï¸', color: '#9c4121', name: 'TOML' },
      markdown: { icon: 'ðŸ“„', color: '#083fa1', name: 'Markdown' },
      jsx: { icon: 'âš›ï¸', color: '#61dafb', name: 'React JSX' },
      tsx: { icon: 'âš›ï¸', color: '#3178c6', name: 'React TSX' },
      vue: { icon: 'ðŸ’š', color: '#42b883', name: 'Vue' },
      svelte: { icon: 'ðŸ”¶', color: '#ff3e00', name: 'Svelte' },
      image: { icon: 'ðŸ–¼ï¸', color: '#10b981', name: 'Image' },
      chart: { icon: 'ðŸ“Š', color: '#8b5cf6', name: 'Chart' },
      react: { icon: 'âš›ï¸', color: '#61dafb', name: 'React' },
      mermaid: { icon: 'ðŸ§œ', color: '#ff6b9d', name: 'Mermaid' },
      canvas: { icon: 'ðŸŽ¨', color: '#f59e0b', name: 'Canvas' },
      p5: { icon: 'ðŸŽ­', color: '#ed225d', name: 'P5.js' },
      threejs: { icon: 'ðŸ§Š', color: '#049ef4', name: 'Three.js' },
      csv: { icon: 'ðŸ“‹', color: '#22c55e', name: 'CSV' },
      text: { icon: 'ðŸ“', color: '#6b7280', name: 'Text' },
      docx: { icon: 'ðŸ“„', color: '#2b579a', name: 'Word Doc' },
    };

    const generators = {
      react: (code) => `<!DOCTYPE html><html><head>
<meta charset="UTF-8" />
<script src="https://cdn.tailwindcss.com"><\/script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"><\/script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"><\/script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"><\/script>
<script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"><\/script>
<script src="https://unpkg.com/lucide-react@0.294.0/dist/umd/lucide-react.min.js"><\/script>
<style>body { margin: 0; font-family: system-ui; background: #0f0f0f; color: white; } .err { padding: 12px; background: #7f1d1d; color: #fca5a5; border-radius: 8px; margin: 16px; }</style>
</head><body><div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback, useMemo, createContext, useContext } = React;
const { LineChart, Line, BarChart, Bar, AreaChart, Area, PieChart, Pie, Cell, XAxis, YAxis, Tooltip, Legend, CartesianGrid, ResponsiveContainer } = Recharts || {};
// Lucide icons - destructure commonly used icons
const { FileCode, Copy, Check, ChevronRight, ChevronDown, Folder, File, Terminal, Play, Settings, Search, GitBranch, Box, Layers, X, Plus, Minus, Edit, Save, Trash, Download, Upload, RefreshCw, ExternalLink, Menu, Home, User, Mail, Phone, Calendar, Clock, Star, Heart, ThumbsUp, AlertCircle, Info, HelpCircle, Eye, EyeOff, Lock, Unlock, Key, Database, Server, Cloud, Wifi, Bluetooth, Battery, Power, Zap, Sun, Moon, Loader, MoreHorizontal, MoreVertical, ArrowUp, ArrowDown, ArrowLeft, ArrowRight, Code, Image, Video, Music, Mic, Camera, Film, Tv, Monitor, Laptop, Smartphone, Tablet, Watch, Headphones, Speaker, Volume, VolumeX, Maximize, Minimize, Share, Link, Bookmark, Flag, Tag, Hash, AtSign, Filter, Sort, Grid, List, Layout, Columns, Sidebar, PanelLeft, PanelRight, Send, MessageSquare, MessageCircle, Bell, BellOff, Globe, Map, MapPin, Navigation, Compass, Target, Crosshair, Activity, BarChart2, TrendingUp, TrendingDown, DollarSign, CreditCard, ShoppingCart, ShoppingBag, Package, Gift, Award, Trophy, Medal, Crown, Gem, Sparkles, Wand, Magic, Palette, Brush, Pen, Pencil, Highlighter, Type, Bold, Italic, Underline, Strikethrough, AlignLeft, AlignCenter, AlignRight, AlignJustify, Indent, Outdent, Quote, ListOrdered, ListChecks, CheckSquare, Square, Circle, Triangle, Hexagon, Octagon, Diamond } = window.lucideReact || {};
class ErrorBoundary extends React.Component {
  constructor(p) { super(p); this.state = { error: null }; }
  static getDerivedStateFromError(error) { return { error }; }
  render() { return this.state.error ? <div className="err">{this.state.error.message}</div> : this.props.children; }
}
try {
  ${code}
  const RootComponent = typeof App !== 'undefined' ? App : (typeof AgentWorkspace !== 'undefined' ? AgentWorkspace : () => <div className="err">No App or AgentWorkspace component</div>);
  ReactDOM.createRoot(document.getElementById('root')).render(<ErrorBoundary><RootComponent /></ErrorBoundary>);
  parent.postMessage({ type: 'ready' }, '*');
} catch (err) {
  document.getElementById('root').innerHTML = '<div class="err">' + err.message + '</div>';
}
new ResizeObserver(() => parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*')).observe(document.body);
<\/script></body></html>`,

      html: (code) => `<!DOCTYPE html><html><head>
<meta charset="UTF-8" /><script src="https://cdn.tailwindcss.com"><\/script>
<style>body { margin: 0; padding: 16px; font-family: system-ui; background: #0f0f0f; color: white; }</style>
</head><body>${code}
<script>parent.postMessage({ type: 'ready' }, '*'); new ResizeObserver(() => parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*')).observe(document.body);<\/script>
</body></html>`,

      mermaid: (code) => `<!DOCTYPE html><html><head>
<meta charset="UTF-8" /><script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"><\/script>
<style>body { margin: 0; padding: 16px; display: flex; justify-content: center; background: #0f0f0f; }</style>
</head><body><div class="mermaid">${code}</div>
<script>mermaid.initialize({ startOnLoad: true, theme: 'dark' }); mermaid.run().then(() => { parent.postMessage({ type: 'ready' }, '*'); parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*'); });<\/script>
</body></html>`,

      markdown: (code) => `<!DOCTYPE html><html><head>
<meta charset="UTF-8" /><script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"><\/script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5/github-markdown-dark.min.css">
<style>body { margin: 0; padding: 16px; background: #0f0f0f; } .markdown-body { background: transparent; }</style>
</head><body><div id="c" class="markdown-body"></div>
<script>document.getElementById('c').innerHTML = marked.parse(\`${code.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`); parent.postMessage({ type: 'ready' }, '*'); parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*');<\/script>
</body></html>`,

      svg: (code) => `<!DOCTYPE html><html><head>
<style>body { margin: 0; padding: 16px; display: flex; justify-content: center; background: #0f0f0f; }</style>
</head><body>${code}<script>parent.postMessage({ type: 'ready' }, '*');<\/script></body></html>`,

      code: (code, lang) => `<!DOCTYPE html><html><head>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css">
<script src="https://cdn.jsdelivr.net/npm/prismjs@1/prism.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-python.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-rust.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-go.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-typescript.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-jsx.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-tsx.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-bash.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-sql.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-yaml.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-toml.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/line-numbers/prism-line-numbers.min.js"><\/script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/line-numbers/prism-line-numbers.min.css">
<style>
* { box-sizing: border-box; }
html, body { margin: 0; padding: 0; background: #1a1a1a; overflow-x: hidden; }
pre { margin: 0; padding: 12px 16px; border-radius: 0; overflow-x: auto; white-space: pre; }
pre.line-numbers { padding-left: 3.5em; }
code { font-family: 'SF Mono', 'Fira Code', 'JetBrains Mono', Consolas, monospace; font-size: 11px; line-height: 1.5; word-break: break-word; }
.line-numbers .line-numbers-rows { border-right: 1px solid #333; padding-right: 8px; }
.line-numbers-rows > span:before { color: #555; }
::-webkit-scrollbar { height: 6px; width: 6px; }
::-webkit-scrollbar-track { background: #1a1a1a; }
::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #555; }
</style>
</head><body><pre class="line-numbers"><code class="language-${lang || 'javascript'}">${escapeHTML(code)}</code></pre>
<script>Prism.highlightAll(); parent.postMessage({ type: 'ready' }, '*'); setTimeout(() => parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*'), 50);<\/script></body></html>`,

      // Canvas/game renderer - for interactive visual outputs
      canvas: (code) => `<!DOCTYPE html><html><head>
<style>
body { margin: 0; background: #0f0f0f; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
canvas { border: 1px solid #333; background: #000; }
</style>
</head><body>
<canvas id="canvas" width="800" height="600"></canvas>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
try {
  ${code}
  parent.postMessage({ type: 'ready' }, '*');
} catch(e) {
  ctx.fillStyle = '#ff6b6b';
  ctx.font = '14px monospace';
  ctx.fillText('Error: ' + e.message, 20, 30);
}
parent.postMessage({ type: 'resize', height: canvas.height + 32 }, '*');
<\/script></body></html>`,

      // P5.js creative coding
      p5: (code) => `<!DOCTYPE html><html><head>
<script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"><\/script>
<style>body { margin: 0; display: flex; justify-content: center; padding: 16px; background: #0f0f0f; }</style>
</head><body>
<script>
${code}
parent.postMessage({ type: 'ready' }, '*');
setTimeout(() => parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*'), 100);
<\/script></body></html>`,

      // Three.js 3D
      threejs: (code) => `<!DOCTYPE html><html><head>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"><\/script>
<style>body { margin: 0; background: #0f0f0f; } canvas { display: block; }</style>
</head><body>
<script>
${code}
parent.postMessage({ type: 'ready' }, '*');
parent.postMessage({ type: 'resize', height: 500 }, '*');
<\/script></body></html>`,

      // CSV/Spreadsheet preview
      csv: (code) => `<!DOCTYPE html><html><head>
<style>
body { margin: 0; padding: 16px; background: #0f0f0f; color: white; font-family: system-ui; }
table { border-collapse: collapse; width: 100%; font-size: 13px; }
th, td { border: 1px solid #333; padding: 8px 12px; text-align: left; }
th { background: #1a1a2e; color: #a855f7; font-weight: 600; }
tr:nth-child(even) { background: #151515; }
tr:hover { background: #1f1f1f; }
</style>
</head><body><div id="table"></div>
<script>
const csv = \`${code.replace(/`/g, '\\`')}\`;
const rows = csv.trim().split('\\n').map(r => r.split(','));
const table = document.createElement('table');
rows.forEach((row, i) => {
  const tr = document.createElement('tr');
  row.forEach(cell => {
    const el = document.createElement(i === 0 ? 'th' : 'td');
    el.textContent = cell.trim();
    tr.appendChild(el);
  });
  table.appendChild(tr);
});
document.getElementById('table').appendChild(table);
parent.postMessage({ type: 'ready' }, '*');
parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*');
<\/script></body></html>`,

      // JSON viewer
      json: (code) => `<!DOCTYPE html><html><head>
<style>
body { margin: 0; padding: 16px; background: #1e1e1e; color: #d4d4d4; font-family: monospace; font-size: 13px; }
.key { color: #9cdcfe; }
.string { color: #ce9178; }
.number { color: #b5cea8; }
.boolean { color: #569cd6; }
.null { color: #569cd6; }
pre { margin: 0; white-space: pre-wrap; }
</style>
</head><body><pre id="json"></pre>
<script>
function syntaxHighlight(json) {
  return json.replace(/("(\\\\u[a-zA-Z0-9]{4}|\\\\[^u]|[^\\\\"])*"(\\s*:)?|\\b(true|false|null)\\b|-?\\d+(?:\\.\\d*)?(?:[eE][+\\-]?\\d+)?)/g, function (match) {
    let cls = 'number';
    if (/^"/.test(match)) { cls = /:$/.test(match) ? 'key' : 'string'; }
    else if (/true|false/.test(match)) { cls = 'boolean'; }
    else if (/null/.test(match)) { cls = 'null'; }
    return '<span class="' + cls + '">' + match + '</span>';
  });
}
try {
  const obj = JSON.parse(\`${code.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`);
  document.getElementById('json').innerHTML = syntaxHighlight(JSON.stringify(obj, null, 2));
} catch(e) {
  document.getElementById('json').textContent = 'Invalid JSON: ' + e.message;
}
parent.postMessage({ type: 'ready' }, '*');
parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*');
<\/script></body></html>`,

      // Plain text / document
      text: (code) => `<!DOCTYPE html><html><head>
<style>
body { margin: 0; padding: 20px; background: #fafafa; color: #333; font-family: 'Georgia', serif; font-size: 14px; line-height: 1.6; max-width: 800px; }
h1, h2, h3 { font-family: system-ui; color: #111; }
p { margin: 1em 0; }
</style>
</head><body>${code.replace(/\n/g, '<br>')}<script>parent.postMessage({ type: 'ready' }, '*'); parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*');<\/script></body></html>`,

      // Image display (base64 or URL)
      image: (code) => `<!DOCTYPE html><html><head>
<style>
body { margin: 0; padding: 16px; background: #0f0f0f; display: flex; justify-content: center; align-items: center; min-height: 200px; }
img { max-width: 100%; max-height: 80vh; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
.error { color: #ff6b6b; font-family: system-ui; }
</style>
</head><body>
<img src="${code}" onerror="this.outerHTML='<div class=error>Failed to load image</div>'" />
<script>parent.postMessage({ type: 'ready' }, '*'); setTimeout(() => parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*'), 100);<\/script>
</body></html>`,

      // Chart (using Chart.js)
      chart: (code) => `<!DOCTYPE html><html><head>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"><\/script>
<style>body { margin: 0; padding: 16px; background: #0f0f0f; } canvas { max-width: 100%; }</style>
</head><body>
<canvas id="chart"></canvas>
<script>
try {
  const config = ${code};
  // Apply dark theme defaults
  Chart.defaults.color = '#9ca3af';
  Chart.defaults.borderColor = '#374151';
  new Chart(document.getElementById('chart'), config);
  parent.postMessage({ type: 'ready' }, '*');
  parent.postMessage({ type: 'resize', height: 400 }, '*');
} catch(e) {
  document.body.innerHTML = '<div style="color:#ff6b6b;font-family:monospace;padding:20px">Chart Error: ' + e.message + '</div>';
}
<\/script></body></html>`,

      // Word document preview (shows as formatted text, download generates .docx)
      docx: (code) => `<!DOCTYPE html><html><head>
<style>
body { margin: 0; padding: 20px; background: #fff; color: #333; font-family: 'Calibri', 'Segoe UI', sans-serif; font-size: 14px; line-height: 1.6; }
h1 { font-size: 24px; color: #2b579a; border-bottom: 2px solid #2b579a; padding-bottom: 8px; }
h2 { font-size: 18px; color: #2b579a; }
p { margin: 1em 0; }
.doc-header { background: #2b579a; color: white; padding: 8px 16px; margin: -20px -20px 20px -20px; font-size: 12px; display: flex; align-items: center; gap: 8px; }
.doc-icon { width: 20px; height: 20px; }
</style>
</head><body>
<div class="doc-header">
  <svg class="doc-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M6 2h8l6 6v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2zm7 1.5V9h5.5L13 3.5zM8 11v2h8v-2H8zm0 4v2h8v-2H8z"/></svg>
  Word Document Preview
</div>
${code.replace(/\n/g, '<br>')}
<script>parent.postMessage({ type: 'ready' }, '*'); parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*');<\/script>
</body></html>`,
    };

    // File extension mapping for downloads
    const fileExtensions = {
      react: 'jsx',
      html: 'html',
      mermaid: 'mmd',
      markdown: 'md',
      svg: 'svg',
      code: 'txt',
      csv: 'csv',
      json: 'json',
      text: 'txt',
      docx: 'docx',
      canvas: 'js',
      p5: 'js',
      threejs: 'js',
      python: 'py',
      javascript: 'js',
      typescript: 'ts',
      rust: 'rs',
      go: 'go',
      image: 'png',
      chart: 'json',
    };

    // MIME types for downloads
    const mimeTypes = {
      react: 'text/javascript',
      html: 'text/html',
      mermaid: 'text/plain',
      markdown: 'text/markdown',
      svg: 'image/svg+xml',
      code: 'text/plain',
      csv: 'text/csv',
      json: 'application/json',
      text: 'text/plain',
      docx: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
      canvas: 'text/javascript',
      p5: 'text/javascript',
      threejs: 'text/javascript',
      python: 'text/x-python',
      javascript: 'text/javascript',
      typescript: 'text/typescript',
      rust: 'text/x-rust',
      go: 'text/x-go',
      image: 'image/png',
      chart: 'application/json',
    };

    function ArtifactPreview({ artifact, onUpdate }) {
      const iframeRef = useRef(null);
      const [height, setHeight] = useState(300);
      const [copied, setCopied] = useState(false);
      const [editing, setEditing] = useState(false);
      const [activeFileIdx, setActiveFileIdx] = useState(0);
      const [showCode, setShowCode] = useState(false);
      const [showMeta, setShowMeta] = useState(false);

      // Get base type (strip subtypes like 'code:module' â†’ 'code')
      const baseType = artifact.type?.split(':')[0] || 'code';
      const subType = artifact.type?.includes(':') ? artifact.type.split(':')[1] : null;

      // Normalize artifact to new format - support both old and new schemas
      const files = artifact.files?.length ? artifact.files : (artifact.content ? [{
        path: artifact.title?.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.' + (artifact.lang || 'txt'),
        language: artifact.lang || baseType || 'text',
        content: artifact.content,
        role: 'source',
        entrypoint: true
      }] : []);

      const activeFile = files[activeFileIdx] || files[0] || { path: 'file.txt', language: 'text', content: '' };
      const [editContent, setEditContent] = useState(activeFile.content);

      // Get execution config (from new format or legacy)
      const execution = artifact.execution || (artifact.runtime || artifact.run ? {
        runtime: artifact.runtime,
        command: artifact.run
      } : null);

      // Get dependencies (from new format)
      const deps = artifact.dependencies?.packages || artifact.dependencies;

      // Editable types - can be live-previewed (use base type for matching)
      const editableTypes = ['react', 'html', 'mermaid', 'svg', 'canvas', 'p5', 'threejs', 'markdown', 'json', 'csv', 'chart', 'd3', 'webgl', 'diagram'];
      const isEditable = editableTypes.includes(baseType);

      // Code-only types - show syntax highlighted code
      const codeOnlyTypes = ['code', 'python', 'javascript', 'typescript', 'rust', 'go', 'bash', 'sql', 'graphql', 'yaml', 'docker', 'terraform', 'config', 'api'];
      const isCodeOnly = codeOnlyTypes.includes(baseType);

      useEffect(() => {
        const handler = (e) => {
          if (e.source !== iframeRef.current?.contentWindow) return;
          if (e.data.type === 'resize') setHeight(Math.max(200, e.data.height + 20));
        };
        window.addEventListener('message', handler);
        return () => window.removeEventListener('message', handler);
      }, []);

      useEffect(() => {
        if (!iframeRef.current || !activeFile) return;
        const content = editing ? editContent : activeFile.content;
        // Use baseType for generator lookup (e.g., 'react:app' â†’ 'react')
        const gen = generators[baseType] || generators.code;
        iframeRef.current.srcdoc = gen(content, activeFile.language);
      }, [artifact, activeFile, editContent, editing, baseType]);

      // Reset edit content when file changes
      useEffect(() => {
        setEditContent(activeFile.content);
      }, [activeFile.content, activeFileIdx]);

      const handleCopy = async () => {
        try {
          await navigator.clipboard.writeText(activeFile.content);
          setCopied(true);
          setTimeout(() => setCopied(false), 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      };

      const handleDownload = async () => {
        // Use the active file's path if available, otherwise construct from title
        const filename = activeFile.path || `${artifact.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.${fileExtensions[artifact.type] || 'txt'}`;

        // Special handling for Word documents - generate real .docx
        if (artifact.type === 'docx' && typeof docx !== 'undefined') {
          try {
            const { Document, Packer, Paragraph, TextRun, HeadingLevel } = docx;

            // Parse content into paragraphs
            const lines = activeFile.content.split('\n');
            const children = lines.map(line => {
              // Detect headers
              if (line.startsWith('# ')) {
                return new Paragraph({
                  text: line.slice(2),
                  heading: HeadingLevel.HEADING_1,
                });
              } else if (line.startsWith('## ')) {
                return new Paragraph({
                  text: line.slice(3),
                  heading: HeadingLevel.HEADING_2,
                });
              } else if (line.startsWith('### ')) {
                return new Paragraph({
                  text: line.slice(4),
                  heading: HeadingLevel.HEADING_3,
                });
              }
              return new Paragraph({
                children: [new TextRun(line)],
              });
            });

            const doc = new Document({
              sections: [{
                properties: {},
                children: children,
              }],
            });

            const blob = await Packer.toBlob(doc);
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            return;
          } catch (err) {
            console.error('Failed to generate docx:', err);
          }
        }

        // Default: plain blob download
        const mime = mimeTypes[activeFile.language] || mimeTypes[artifact.type] || 'text/plain';
        const blob = new Blob([activeFile.content], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      const langInfo = langMeta[activeFile.language] || langMeta[artifact.lang] || langMeta[baseType] || { icon: 'ðŸ“„', color: '#6b7280', name: artifact.type };
      const hasMultipleFiles = files.length > 1;
      const hasMeta = artifact.description || artifact.tags?.length || execution || deps || artifact.version;

      return (
        <div className="border border-spawn-border rounded-lg overflow-hidden bg-[#0f0f0f] max-w-full">
          {/* Header */}
          <div className="bg-spawn-surface border-b border-spawn-border">
            <div className="h-10 flex items-center justify-between px-3">
              <div className="flex items-center gap-2 overflow-hidden">
                <span className="text-sm flex-shrink-0" title={langInfo.name}>{langInfo.icon}</span>
                <span className="text-xs px-1.5 py-0.5 rounded uppercase font-medium flex-shrink-0" style={{ background: `${langInfo.color}20`, color: langInfo.color }}>
                  {baseType}
                </span>
                {subType && (
                  <span className="text-xs px-1.5 py-0.5 bg-gray-700/50 text-gray-400 rounded flex-shrink-0">
                    {subType}
                  </span>
                )}
                <span className="text-sm text-white font-medium truncate">{artifact.title}</span>
                {execution?.runtime && (
                  <span className="text-xs px-1.5 py-0.5 bg-blue-500/20 text-blue-400 rounded flex-shrink-0">
                    {execution.runtime}
                  </span>
                )}
                {artifact.version?.number && (
                  <span className="text-xs px-1.5 py-0.5 bg-green-500/20 text-green-400 rounded flex-shrink-0">
                    v{artifact.version.number}
                  </span>
                )}
                {editing && <span className="text-xs px-1.5 py-0.5 bg-yellow-500/20 text-yellow-400 rounded flex-shrink-0">Editing</span>}
              </div>
            <div className="flex items-center gap-1 flex-shrink-0">
              {/* Info/metadata button */}
              {hasMeta && (
                <button
                  onClick={() => setShowMeta(!showMeta)}
                  className={`p-1.5 rounded transition-colors ${showMeta ? 'bg-cyan-600/20 text-cyan-400' : 'hover:bg-spawn-border text-spawn-muted hover:text-white'}`}
                  title="Show artifact info"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </button>
              )}
              {/* Toggle code/preview for editable types */}
              {isEditable && !isCodeOnly && (
                <button
                  onClick={() => setShowCode(!showCode)}
                  className={`p-1.5 rounded transition-colors ${showCode ? 'bg-purple-600/20 text-purple-400' : 'hover:bg-spawn-border text-spawn-muted hover:text-white'}`}
                  title={showCode ? "Show preview" : "Show code"}
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                  </svg>
                </button>
              )}
              {/* Edit button */}
              {isEditable && (
                <button
                  onClick={() => setEditing(!editing)}
                  className={`p-1.5 rounded transition-colors ${editing ? 'bg-purple-600/20 text-purple-400' : 'hover:bg-spawn-border text-spawn-muted hover:text-white'}`}
                  title={editing ? "Exit edit mode" : "Edit code"}
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                </button>
              )}
              <button
                onClick={handleCopy}
                className="p-1.5 hover:bg-spawn-border rounded transition-colors text-spawn-muted hover:text-white"
                title="Copy to clipboard"
              >
                {copied ? (
                  <svg className="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                  </svg>
                ) : (
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                  </svg>
                )}
              </button>
              <button
                onClick={handleDownload}
                className="p-1.5 hover:bg-spawn-border rounded transition-colors text-spawn-muted hover:text-white"
                title="Download file"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
              </button>
            </div>
            </div>

            {/* Metadata panel */}
            {showMeta && (
              <div className="px-3 py-2 text-xs border-t border-spawn-border/50 bg-spawn-bg/30 space-y-2">
                {artifact.description && (
                  <p className="text-spawn-muted">{artifact.description}</p>
                )}
                {artifact.tags?.length > 0 && (
                  <div className="flex flex-wrap gap-1">
                    {artifact.tags.map((tag, i) => (
                      <span key={i} className="px-1.5 py-0.5 bg-purple-500/20 text-purple-400 rounded">#{tag}</span>
                    ))}
                  </div>
                )}
                {execution?.command && (
                  <div className="flex items-center gap-2">
                    <span className="text-spawn-muted">Run:</span>
                    <code className="text-green-400 font-mono bg-black/30 px-1.5 py-0.5 rounded">{execution.command}</code>
                  </div>
                )}
                {deps && Object.keys(deps).length > 0 && (
                  <div className="flex items-center gap-2 flex-wrap">
                    <span className="text-spawn-muted">Deps:</span>
                    {Object.entries(deps).slice(0, 5).map(([name, ver]) => (
                      <span key={name} className="text-cyan-400 font-mono bg-black/30 px-1.5 py-0.5 rounded text-xs">{name}@{ver}</span>
                    ))}
                    {Object.keys(deps).length > 5 && <span className="text-spawn-muted">+{Object.keys(deps).length - 5} more</span>}
                  </div>
                )}
                {artifact.id && (
                  <div className="flex items-center gap-2 text-spawn-muted/50">
                    <span>ID: {artifact.id}</span>
                    {artifact.checksum && <span>â€¢ {artifact.checksum.slice(0, 20)}...</span>}
                  </div>
                )}
              </div>
            )}

            {/* File tabs - shown when multiple files */}
            {hasMultipleFiles && (
              <div className="flex items-center gap-0.5 px-2 pb-1 overflow-x-auto">
                {files.map((file, idx) => {
                  const fileLang = langMeta[file.language] || { icon: 'ðŸ“„', color: '#6b7280' };
                  return (
                    <button
                      key={idx}
                      onClick={() => setActiveFileIdx(idx)}
                      className={`flex items-center gap-1.5 px-2.5 py-1 text-xs rounded-t transition-colors whitespace-nowrap ${
                        idx === activeFileIdx
                          ? 'bg-[#0f0f0f] text-white border-t border-l border-r border-spawn-border'
                          : 'text-spawn-muted hover:text-white hover:bg-spawn-border/50'
                      }`}
                    >
                      <span>{fileLang.icon}</span>
                      <span className="font-mono">{file.path.split('/').pop()}</span>
                    </button>
                  );
                })}
              </div>
            )}

            {/* Run command info */}
            {artifact.run && (
              <div className="flex items-center gap-2 px-3 py-1.5 text-xs border-t border-spawn-border/50 bg-spawn-bg/30">
                <span className="text-spawn-muted">Run:</span>
                <code className="text-green-400 font-mono">{artifact.run}</code>
              </div>
            )}
          </div>

          {/* Content area - either editor or preview */}
          {editing ? (
            <div className="flex" style={{ height: Math.max(300, height) }}>
              {/* Code editor */}
              <div className="flex-1 overflow-hidden">
                <textarea
                  value={editContent}
                  onChange={(e) => setEditContent(e.target.value)}
                  className="w-full h-full bg-[#1e1e1e] text-gray-200 font-mono text-sm p-4 resize-none outline-none border-r border-spawn-border"
                  style={{ fontFamily: "'JetBrains Mono', 'Fira Code', monospace" }}
                  spellCheck={false}
                />
              </div>
              {/* Live preview */}
              {isEditable && !isCodeOnly && (
                <div className="flex-1 overflow-hidden">
                  <iframe ref={iframeRef} className="w-full h-full border-0" sandbox="allow-scripts" referrerPolicy="no-referrer" />
                </div>
              )}
            </div>
          ) : showCode ? (
            <div className="overflow-auto" style={{ maxHeight: 500 }}>
              <pre className="text-sm p-4 bg-[#1e1e1e] text-gray-300 font-mono overflow-x-auto whitespace-pre" style={{ margin: 0 }}>
                <code>{activeFile.content}</code>
              </pre>
            </div>
          ) : (
            <div className="overflow-hidden" style={{ maxHeight: 600 }}>
              <iframe
                ref={iframeRef}
                className="w-full border-0"
                style={{ height: Math.min(height, 600) }}
                sandbox="allow-scripts"
                referrerPolicy="no-referrer"
                loading="lazy"
              />
            </div>
          )}
        </div>
      );
    }

    // ==================== Message Components ====================
    function ToolCallDisplay({ tool, args, result }) {
      const [expanded, setExpanded] = useState(false);
      const isSuccess = result?.success !== false;
      const isPending = !result;

      // Compact summary based on tool type
      const getSummary = () => {
        if (tool === 'write_file') return args?.path?.split('/').pop() || 'file';
        if (tool === 'read_file') return args?.path?.split('/').pop() || 'file';
        if (tool === 'execute_command') return args?.command?.slice(0, 30) || 'cmd';
        if (tool === 'list_files') return args?.path || '.';
        if (tool === 'create_artifact') return args?.title || args?.type || 'artifact';
        return JSON.stringify(args).slice(0, 25);
      };

      return (
        <div
          className={`inline-flex items-center gap-1.5 px-2 py-1 rounded text-xs cursor-pointer transition-all mr-1 mb-1 ${
            isPending ? 'bg-yellow-500/20 border border-yellow-500/30' :
            isSuccess ? 'bg-green-500/10 border border-green-500/20 hover:bg-green-500/20' :
            'bg-red-500/10 border border-red-500/20 hover:bg-red-500/20'
          }`}
          onClick={() => setExpanded(!expanded)}
          title={`${tool}: ${JSON.stringify(args)}`}
        >
          <span className={`w-1.5 h-1.5 rounded-full ${
            isPending ? 'bg-yellow-400 animate-pulse' :
            isSuccess ? 'bg-green-400' : 'bg-red-400'
          }`} />
          <span className="font-mono text-purple-400">{tool}</span>
          <span className="text-spawn-muted truncate max-w-[120px]">{getSummary()}</span>
          {expanded && (
            <div className="absolute left-0 top-full mt-1 z-50 bg-[#0a0a0a] border border-spawn-border rounded-lg p-3 shadow-xl min-w-[300px] max-w-[500px]" onClick={e => e.stopPropagation()}>
              <div className="text-xs text-spawn-muted mb-1">Arguments:</div>
              <pre className="text-xs text-green-400 mb-3 overflow-auto max-h-32 whitespace-pre-wrap">{JSON.stringify(args, null, 2)}</pre>
              {result && (
                <>
                  <div className="text-xs text-spawn-muted mb-1">Result:</div>
                  <pre className="text-xs text-cyan-400 overflow-auto max-h-32 whitespace-pre-wrap">{JSON.stringify(result, null, 2)}</pre>
                </>
              )}
            </div>
          )}
        </div>
      );
    }

    // Group of tool calls - shows parallel execution
    function ToolCallGroup({ toolCalls }) {
      if (!toolCalls?.length) return null;
      return (
        <div className="flex flex-wrap items-center gap-0.5 my-2 relative">
          <span className="text-xs text-spawn-muted mr-1">Tools:</span>
          {toolCalls.map((tc, i) => (
            <ToolCallDisplay key={i} {...tc} />
          ))}
        </div>
      );
    }

    function Message({ message }) {
      const isUser = message.role === 'user';
      const isSystem = message.role === 'system';

      if (isSystem) return null;

      return (
        <div className="flex gap-3">
          <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 text-sm font-bold ${
            isUser ? 'bg-blue-600' : 'bg-gradient-to-br from-purple-600 to-pink-600'
          }`}>
            {isUser ? 'ðŸ‘¤' : 'A'}
          </div>
          <div className="flex-1 max-w-[80%]">
            <div className={`inline-block rounded-2xl px-4 py-2 ${
              isUser ? 'bg-blue-600 text-white' : 'bg-spawn-surface text-spawn-text'
            }`}>
              <p className="text-sm whitespace-pre-wrap">{message.content}</p>
            </div>

            {/* Tool calls - compact inline chips */}
            <ToolCallGroup toolCalls={message.toolCalls} />

            {/* Artifacts */}
            {message.artifacts?.map((artifact, i) => (
              <div key={i} className="mt-3">
                <ArtifactPreview artifact={artifact} />
              </div>
            ))}

            {message.timestamp && (
              <div className="text-xs text-spawn-muted mt-1">
                {new Date(message.timestamp).toLocaleTimeString()}
              </div>
            )}
          </div>
        </div>
      );
    }

    // ==================== Main App ====================
    function App() {
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const [loading, setLoading] = useState(false);
      const [thinking, setThinking] = useState('');
      const [serverStatus, setServerStatus] = useState(null);
      const [selectedArtifact, setSelectedArtifact] = useState(null);
      const [canvasOpen, setCanvasOpen] = useState(false);
      const messagesEndRef = useRef(null);
      const inputRef = useRef(null);

      // Get all artifacts from messages
      const allArtifacts = messages.flatMap((m, mi) =>
        (m.artifacts || []).map((a, ai) => ({ ...a, messageIndex: mi, artifactIndex: ai }))
      );

      // Auto-open canvas when first artifact arrives
      useEffect(() => {
        if (allArtifacts.length > 0 && !canvasOpen) {
          setCanvasOpen(true);
          setSelectedArtifact(allArtifacts[allArtifacts.length - 1]);
        }
      }, [allArtifacts.length]);

      // Check server health
      useEffect(() => {
        fetch('/health')
          .then(r => r.json())
          .then(setServerStatus)
          .catch(() => setServerStatus({ status: 'offline' }));
      }, []);

      // Auto-scroll
      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages, thinking]);

      // Send message
      const sendMessage = async () => {
        if (!input.trim() || loading) return;

        const userMessage = {
          role: 'user',
          content: input.trim(),
          timestamp: new Date(),
        };

        setMessages(prev => [...prev, userMessage]);
        setInput('');
        setLoading(true);
        setThinking('Thinking...');

        try {
          // Use streaming endpoint
          const response = await fetch('/api/chat/stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message: userMessage.content,
              history: messages.slice(-10).map(m => ({ role: m.role, content: m.content })),
            }),
          });

          const reader = response.body.getReader();
          const decoder = new TextDecoder();

          let assistantMessage = {
            role: 'assistant',
            content: '',
            toolCalls: [],
            artifacts: [],
            timestamp: new Date(),
          };

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n').filter(l => l.startsWith('data: '));

            for (const line of lines) {
              try {
                const data = JSON.parse(line.slice(6));

                switch (data.type) {
                  case 'thinking':
                    setThinking(`Thinking... (step ${data.iteration})`);
                    break;
                  case 'tool_start':
                    setThinking(`Running ${data.tool}...`);
                    // Store args from tool_start for pairing with result
                    assistantMessage._pendingTool = { tool: data.tool, args: data.args };
                    break;
                  case 'tool_result':
                    assistantMessage.toolCalls.push({
                      tool: data.tool,
                      args: assistantMessage._pendingTool?.args || {},
                      result: data.result,
                    });
                    // Update message in place
                    setMessages(prev => {
                      const updated = [...prev];
                      const lastIdx = updated.length - 1;
                      if (updated[lastIdx]?.role === 'assistant') {
                        updated[lastIdx] = { ...assistantMessage };
                      } else {
                        updated.push({ ...assistantMessage });
                      }
                      return updated;
                    });
                    break;
                  case 'artifact':
                    assistantMessage.artifacts.push(data.artifact);
                    setMessages(prev => {
                      const updated = [...prev];
                      if (updated[updated.length - 1]?.role === 'assistant') {
                        updated[updated.length - 1] = { ...assistantMessage };
                      }
                      return updated;
                    });
                    break;
                  case 'response':
                    assistantMessage.content = data.content;
                    setMessages(prev => {
                      const updated = [...prev];
                      const lastIdx = updated.length - 1;
                      if (updated[lastIdx]?.role === 'assistant') {
                        updated[lastIdx] = { ...assistantMessage };
                      } else {
                        updated.push({ ...assistantMessage });
                      }
                      return updated;
                    });
                    break;
                  case 'done':
                    setThinking('');
                    break;
                  case 'error':
                    setThinking('');
                    assistantMessage.content = `Error: ${data.message}`;
                    setMessages(prev => [...prev, { ...assistantMessage }]);
                    break;
                }
              } catch {}
            }
          }

          // Ensure final message is added
          if (assistantMessage.content || assistantMessage.toolCalls.length || assistantMessage.artifacts.length) {
            setMessages(prev => {
              const updated = [...prev];
              const lastIdx = updated.length - 1;
              if (updated[lastIdx]?.role !== 'assistant') {
                updated.push({ ...assistantMessage });
              }
              return updated;
            });
          }

        } catch (err) {
          setMessages(prev => [...prev, {
            role: 'assistant',
            content: `Error: ${err.message}`,
            timestamp: new Date(),
          }]);
        } finally {
          setLoading(false);
          setThinking('');
          inputRef.current?.focus();
        }
      };

      const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      };

      return (
        <div className="h-screen flex bg-spawn-bg justify-center">
          {/* Left Panel - Chat (clean, no borders) */}
          <div className={`flex flex-col transition-all duration-300 ${canvasOpen ? 'w-[45%] flex-shrink-0' : 'w-full max-w-4xl'}`}>
            {/* Header */}
            <header className="h-12 flex items-center justify-between px-4 bg-spawn-bg flex-shrink-0">
              <div className="flex items-center gap-2">
                <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center font-bold text-white text-sm">
                  A
                </div>
                <div>
                  <span className="font-semibold text-white text-sm">ARCHITECT</span>
                  <span className="text-xs text-spawn-muted ml-2">Grok 4.1</span>
                </div>
              </div>
              <div className="flex items-center gap-2">
                <div className="flex items-center gap-1">
                  <div className={`w-1.5 h-1.5 rounded-full ${serverStatus?.status === 'healthy' ? 'bg-green-500' : 'bg-red-500'}`} />
                  <span className="text-xs text-spawn-muted">{serverStatus?.status === 'healthy' ? 'Online' : 'Offline'}</span>
                </div>
                {/* GitHub repo link */}
                <a
                  href="https://github.com/anthropics/claude-code"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="p-1.5 rounded transition-colors hover:bg-spawn-surface text-spawn-muted hover:text-white"
                  title="View on GitHub"
                >
                  <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path fillRule="evenodd" clipRule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.17 6.839 9.49.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.604-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.464-1.11-1.464-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.831.092-.646.35-1.086.636-1.336-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.167 22 16.418 22 12c0-5.523-4.477-10-10-10z" />
                  </svg>
                </a>
                {allArtifacts.length > 0 && (
                  <button
                    onClick={() => setCanvasOpen(!canvasOpen)}
                    className={`p-1.5 rounded transition-colors ${canvasOpen ? 'bg-purple-600/20 text-purple-400' : 'hover:bg-spawn-surface text-spawn-muted'}`}
                    title={canvasOpen ? 'Close canvas' : 'Open canvas'}
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
                    </svg>
                  </button>
                )}
              </div>
            </header>

            {/* Messages */}
            <div className="flex-1 overflow-auto p-4 space-y-4 hide-scrollbar">
            {messages.length === 0 && (
              <div className="flex flex-col items-center justify-center h-full">
                <h1 className="text-3xl font-bold text-white mb-2">What can I help you build?</h1>
                <p className="text-spawn-muted text-sm mb-8">
                  Full sandbox access â€¢ Execute code â€¢ Create artifacts
                </p>
                <div className="flex flex-wrap gap-2 justify-center max-w-xl">
                  {[
                    { icon: 'ðŸŽ¯', text: 'React todo app' },
                    { icon: 'ðŸ“Š', text: 'Dashboard with charts' },
                    { icon: 'ðŸ”€', text: 'Mermaid diagram' },
                    { icon: 'ðŸ–¥ï¸', text: 'Run terminal commands' },
                    { icon: 'ðŸ› ï¸', text: 'Show available tools' },
                  ].map((item, i) => (
                    <button
                      key={i}
                      onClick={() => { setInput(item.text); inputRef.current?.focus(); }}
                      className="flex items-center gap-2 px-4 py-2 bg-spawn-surface hover:bg-spawn-border text-sm text-spawn-text rounded-full border border-spawn-border hover:border-spawn-muted transition-all"
                    >
                      <span>{item.icon}</span>
                      <span>{item.text}</span>
                    </button>
                  ))}
                </div>
              </div>
            )}

            {messages.map((msg, i) => (
              <Message key={i} message={msg} />
            ))}

            {thinking && (
              <div className="flex gap-3">
                <div className="w-8 h-8 rounded-full bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center flex-shrink-0">
                  <SpinnerCircle size={18} className="text-white" />
                </div>
                <div className="bg-spawn-surface rounded-2xl px-4 py-3 flex items-center gap-3">
                  <SpinnerEllipsis size={20} className="text-purple-400" />
                  <span className="text-sm text-spawn-muted">{thinking}</span>
                </div>
              </div>
            )}

            <div ref={messagesEndRef} />
          </div>

          {/* Input - v0 style */}
          <div className="p-4 bg-spawn-bg flex-shrink-0">
            <div className="max-w-3xl mx-auto">
              <div className="relative bg-spawn-surface rounded-xl border border-spawn-border focus-within:border-purple-600/50 transition-colors">
                <textarea
                  ref={inputRef}
                  value={input}
                  onChange={(e) => {
                    setInput(e.target.value);
                    // Auto-resize
                    e.target.style.height = '56px';
                    e.target.style.height = Math.min(e.target.scrollHeight, 200) + 'px';
                  }}
                  onKeyDown={handleKeyDown}
                  placeholder="Ask ARCHITECT to build something..."
                  className="w-full bg-transparent px-4 py-4 text-sm text-white placeholder-spawn-muted resize-none focus:outline-none auto-resize-textarea"
                  style={{ minHeight: '56px' }}
                  disabled={loading}
                />
                <div className="flex items-center justify-between px-3 pb-3">
                  <div className="flex items-center gap-1">
                    {/* Attach file button */}
                    <button
                      className="p-1.5 rounded-lg transition-colors hover:bg-spawn-border text-spawn-muted hover:text-white"
                      title="Attach file"
                      onClick={() => document.getElementById('file-input').click()}
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                      </svg>
                    </button>
                    <input type="file" id="file-input" className="hidden" multiple />
                    {/* Attach image button */}
                    <button
                      className="p-1.5 rounded-lg transition-colors hover:bg-spawn-border text-spawn-muted hover:text-white"
                      title="Attach image"
                      onClick={() => document.getElementById('image-input').click()}
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                    </button>
                    <input type="file" id="image-input" className="hidden" accept="image/*" multiple />
                    <span className="text-xs text-spawn-muted ml-1">Enter to send</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <button
                      onClick={sendMessage}
                      disabled={loading || !input.trim()}
                      className={`p-2 rounded-lg transition-all ${
                        input.trim() && !loading
                          ? 'bg-white text-black hover:bg-gray-200'
                          : 'bg-spawn-border text-spawn-muted cursor-not-allowed'
                      }`}
                    >
                      {loading ? (
                        <SpinnerCircle size={16} className="text-spawn-muted" />
                      ) : (
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 10l7-7m0 0l7 7m-7-7v18" />
                        </svg>
                      )}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          </div>

          {/* Right Panel - Canvas (artifacts) - with border wrap */}
          {canvasOpen && (
            <div className="flex-1 flex flex-col min-w-0 p-3 pl-0">
              <div className="flex-1 flex flex-col bg-spawn-surface rounded-xl border border-spawn-border overflow-hidden">
              {/* Canvas Header */}
              <div className="h-11 border-b border-spawn-border/50 flex items-center justify-between px-4 flex-shrink-0 bg-spawn-bg/50">
                <div className="flex items-center gap-2 overflow-hidden">
                  <span className="text-sm font-medium text-white truncate">
                    {selectedArtifact?.title || 'Canvas'}
                  </span>
                  {selectedArtifact?.type && (
                    <span className="text-xs px-1.5 py-0.5 bg-purple-600/20 text-purple-400 rounded flex-shrink-0">
                      {selectedArtifact.type}
                    </span>
                  )}
                </div>
                <div className="flex items-center gap-1">
                  {/* Artifact selector dropdown */}
                  {allArtifacts.length > 1 && (
                    <select
                      value={selectedArtifact ? `${selectedArtifact.messageIndex}-${selectedArtifact.artifactIndex}` : ''}
                      onChange={(e) => {
                        const [mi, ai] = e.target.value.split('-').map(Number);
                        const artifact = allArtifacts.find(a => a.messageIndex === mi && a.artifactIndex === ai);
                        if (artifact) setSelectedArtifact(artifact);
                      }}
                      className="text-xs bg-spawn-surface border border-spawn-border rounded px-2 py-1 text-white"
                    >
                      {allArtifacts.map((a, i) => (
                        <option key={i} value={`${a.messageIndex}-${a.artifactIndex}`}>
                          {a.title || `Artifact ${i + 1}`}
                        </option>
                      ))}
                    </select>
                  )}
                  <button
                    onClick={() => setCanvasOpen(false)}
                    className="p-1.5 hover:bg-spawn-surface rounded text-spawn-muted hover:text-white"
                    title="Close canvas"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              </div>

              {/* Canvas Content */}
              <div className="flex-1 overflow-auto p-3">
                {selectedArtifact ? (
                  <ArtifactPreview artifact={selectedArtifact} />
                ) : (
                  <div className="flex items-center justify-center h-full text-spawn-muted text-sm">
                    No artifact selected
                  </div>
                )}
              </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
