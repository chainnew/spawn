<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ARCHITECT ‚Äî AI Development Agent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            spawn: { bg: '#0a0a0a', surface: '#141414', border: '#262626', accent: '#a855f7', text: '#e5e5e5', muted: '#737373' }
          }
        }
      }
    }
  </script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; background: #0a0a0a; color: #e5e5e5; font-family: system-ui, -apple-system, sans-serif; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #141414; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #444; }
    .typing-cursor::after { content: '‚ñã'; animation: blink 1s infinite; }
    @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
    pre { margin: 0; white-space: pre-wrap; word-break: break-word; }
    /* Markdown styles */
    .markdown-content { font-size: 14px; line-height: 1.6; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; }
    .markdown-content h1 { font-size: 1.5em; font-weight: 700; margin: 16px 0 8px; color: #a855f7; border-bottom: 1px solid #333; padding-bottom: 4px; }
    .markdown-content h2 { font-size: 1.25em; font-weight: 600; margin: 14px 0 6px; color: #c084fc; }
    .markdown-content h3 { font-size: 1.1em; font-weight: 600; margin: 12px 0 4px; color: #d8b4fe; }
    .markdown-content p { margin: 8px 0; }
    .markdown-content pre { background: #1a1a1a; border: 1px solid #333; border-radius: 6px; padding: 12px; margin: 10px 0; overflow-x: auto; font-family: 'JetBrains Mono', 'Fira Code', monospace; font-size: 13px; }
    .markdown-content code { background: #262626; padding: 2px 6px; border-radius: 3px; font-family: 'JetBrains Mono', 'Fira Code', monospace; font-size: 13px; }
    .markdown-content pre code { background: none; padding: 0; }
    .markdown-content ul, .markdown-content ol { margin: 8px 0; padding-left: 24px; }
    .markdown-content li { margin: 4px 0; }
    .markdown-content blockquote { border-left: 3px solid #a855f7; margin: 10px 0; padding-left: 12px; color: #999; }
    .markdown-content table { border-collapse: collapse; width: 100%; margin: 10px 0; }
    .markdown-content th, .markdown-content td { border: 1px solid #333; padding: 8px 12px; text-align: left; }
    .markdown-content th { background: #1a1a1a; font-weight: 600; }
    .markdown-content strong { color: #f5f5f5; font-weight: 600; }
    .markdown-content em { font-style: italic; color: #d4d4d4; }
    .markdown-content a { color: #a855f7; text-decoration: none; }
    .markdown-content a:hover { text-decoration: underline; }
    .markdown-content hr { border: none; border-top: 1px solid #333; margin: 16px 0; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ==================== Artifact Renderer ====================
    const escapeHTML = (str = '') => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

    const generators = {
      react: (code) => `<!DOCTYPE html><html><head>
<meta charset="UTF-8" />
<script src="https://cdn.tailwindcss.com"><\/script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"><\/script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"><\/script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"><\/script>
<script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"><\/script>
<style>body { margin: 0; padding: 16px; font-family: system-ui; background: #0f0f0f; color: white; } .err { padding: 12px; background: #7f1d1d; color: #fca5a5; border-radius: 8px; }</style>
</head><body><div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback, useMemo } = React;
const { LineChart, Line, BarChart, Bar, AreaChart, Area, PieChart, Pie, Cell, XAxis, YAxis, Tooltip, Legend, CartesianGrid, ResponsiveContainer } = Recharts || {};
class ErrorBoundary extends React.Component {
  constructor(p) { super(p); this.state = { error: null }; }
  static getDerivedStateFromError(error) { return { error }; }
  render() { return this.state.error ? <div className="err">{this.state.error.message}</div> : this.props.children; }
}
try {
  ${code}
  const RootComponent = typeof App !== 'undefined' ? App : () => <div className="err">No App component</div>;
  ReactDOM.createRoot(document.getElementById('root')).render(<ErrorBoundary><RootComponent /></ErrorBoundary>);
  parent.postMessage({ type: 'ready' }, '*');
} catch (err) {
  document.getElementById('root').innerHTML = '<div class="err">' + err.message + '</div>';
}
new ResizeObserver(() => parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*')).observe(document.body);
<\/script></body></html>`,

      html: (code) => `<!DOCTYPE html><html><head>
<meta charset="UTF-8" /><script src="https://cdn.tailwindcss.com"><\/script>
<style>body { margin: 0; padding: 16px; font-family: system-ui; background: #0f0f0f; color: white; }</style>
</head><body>${code}
<script>parent.postMessage({ type: 'ready' }, '*'); new ResizeObserver(() => parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*')).observe(document.body);<\/script>
</body></html>`,

      mermaid: (code) => `<!DOCTYPE html><html><head>
<meta charset="UTF-8" /><script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"><\/script>
<style>body { margin: 0; padding: 16px; display: flex; justify-content: center; background: #0f0f0f; }</style>
</head><body><div class="mermaid">${code}</div>
<script>mermaid.initialize({ startOnLoad: true, theme: 'dark' }); mermaid.run().then(() => { parent.postMessage({ type: 'ready' }, '*'); parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*'); });<\/script>
</body></html>`,

      markdown: (code) => `<!DOCTYPE html><html><head>
<meta charset="UTF-8" /><script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"><\/script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5/github-markdown-dark.min.css">
<style>body { margin: 0; padding: 16px; background: #0f0f0f; } .markdown-body { background: transparent; }</style>
</head><body><div id="c" class="markdown-body"></div>
<script>document.getElementById('c').innerHTML = marked.parse(\`${code.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`); parent.postMessage({ type: 'ready' }, '*'); parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*');<\/script>
</body></html>`,

      svg: (code) => `<!DOCTYPE html><html><head>
<style>body { margin: 0; padding: 16px; display: flex; justify-content: center; background: #0f0f0f; }</style>
</head><body>${code}<script>parent.postMessage({ type: 'ready' }, '*');<\/script></body></html>`,

      code: (code, lang) => `<!DOCTYPE html><html><head>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css">
<script src="https://cdn.jsdelivr.net/npm/prismjs@1/prism.min.js"><\/script>
<style>body { margin: 0; background: #1e1e1e; } pre { margin: 0; padding: 16px; } code { font-family: 'JetBrains Mono', monospace; font-size: 13px; }</style>
</head><body><pre><code class="language-${lang || 'javascript'}">${escapeHTML(code)}</code></pre>
<script>Prism.highlightAll(); parent.postMessage({ type: 'ready' }, '*');<\/script></body></html>`,

      // CSV/Spreadsheet preview
      csv: (code) => `<!DOCTYPE html><html><head>
<style>
body { margin: 0; padding: 16px; background: #0f0f0f; color: white; font-family: system-ui; }
table { border-collapse: collapse; width: 100%; font-size: 13px; }
th, td { border: 1px solid #333; padding: 8px 12px; text-align: left; }
th { background: #1a1a2e; color: #a855f7; font-weight: 600; }
tr:nth-child(even) { background: #151515; }
tr:hover { background: #1f1f1f; }
</style>
</head><body><div id="table"></div>
<script>
const csv = \`${code.replace(/`/g, '\\`')}\`;
const rows = csv.trim().split('\\n').map(r => r.split(','));
const table = document.createElement('table');
rows.forEach((row, i) => {
  const tr = document.createElement('tr');
  row.forEach(cell => {
    const el = document.createElement(i === 0 ? 'th' : 'td');
    el.textContent = cell.trim();
    tr.appendChild(el);
  });
  table.appendChild(tr);
});
document.getElementById('table').appendChild(table);
parent.postMessage({ type: 'ready' }, '*');
parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*');
<\/script></body></html>`,

      // JSON viewer
      json: (code) => `<!DOCTYPE html><html><head>
<style>
body { margin: 0; padding: 16px; background: #1e1e1e; color: #d4d4d4; font-family: monospace; font-size: 13px; }
.key { color: #9cdcfe; }
.string { color: #ce9178; }
.number { color: #b5cea8; }
.boolean { color: #569cd6; }
.null { color: #569cd6; }
pre { margin: 0; white-space: pre-wrap; }
</style>
</head><body><pre id="json"></pre>
<script>
function syntaxHighlight(json) {
  return json.replace(/("(\\\\u[a-zA-Z0-9]{4}|\\\\[^u]|[^\\\\"])*"(\\s*:)?|\\b(true|false|null)\\b|-?\\d+(?:\\.\\d*)?(?:[eE][+\\-]?\\d+)?)/g, function (match) {
    let cls = 'number';
    if (/^"/.test(match)) { cls = /:$/.test(match) ? 'key' : 'string'; }
    else if (/true|false/.test(match)) { cls = 'boolean'; }
    else if (/null/.test(match)) { cls = 'null'; }
    return '<span class="' + cls + '">' + match + '</span>';
  });
}
try {
  const obj = JSON.parse(\`${code.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`);
  document.getElementById('json').innerHTML = syntaxHighlight(JSON.stringify(obj, null, 2));
} catch(e) {
  document.getElementById('json').textContent = 'Invalid JSON: ' + e.message;
}
parent.postMessage({ type: 'ready' }, '*');
parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*');
<\/script></body></html>`,

      // Plain text / document
      text: (code) => `<!DOCTYPE html><html><head>
<style>
body { margin: 0; padding: 20px; background: #fafafa; color: #333; font-family: 'Georgia', serif; font-size: 14px; line-height: 1.6; max-width: 800px; }
h1, h2, h3 { font-family: system-ui; color: #111; }
p { margin: 1em 0; }
</style>
</head><body>${code.replace(/\n/g, '<br>')}<script>parent.postMessage({ type: 'ready' }, '*'); parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*');<\/script></body></html>`,

      // Word document preview (shows as formatted text, download generates .docx)
      docx: (code) => `<!DOCTYPE html><html><head>
<style>
body { margin: 0; padding: 20px; background: #fff; color: #333; font-family: 'Calibri', 'Segoe UI', sans-serif; font-size: 14px; line-height: 1.6; }
h1 { font-size: 24px; color: #2b579a; border-bottom: 2px solid #2b579a; padding-bottom: 8px; }
h2 { font-size: 18px; color: #2b579a; }
p { margin: 1em 0; }
.doc-header { background: #2b579a; color: white; padding: 8px 16px; margin: -20px -20px 20px -20px; font-size: 12px; display: flex; align-items: center; gap: 8px; }
.doc-icon { width: 20px; height: 20px; }
</style>
</head><body>
<div class="doc-header">
  <svg class="doc-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M6 2h8l6 6v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2zm7 1.5V9h5.5L13 3.5zM8 11v2h8v-2H8zm0 4v2h8v-2H8z"/></svg>
  Word Document Preview
</div>
${code.replace(/\n/g, '<br>')}
<script>parent.postMessage({ type: 'ready' }, '*'); parent.postMessage({ type: 'resize', height: document.body.scrollHeight }, '*');<\/script>
</body></html>`,
    };

    // File extension mapping for downloads
    const fileExtensions = {
      react: 'jsx',
      html: 'html',
      mermaid: 'mmd',
      markdown: 'md',
      svg: 'svg',
      code: 'txt',
      csv: 'csv',
      json: 'json',
      text: 'txt',
      docx: 'docx',
    };

    // MIME types for downloads
    const mimeTypes = {
      react: 'text/javascript',
      html: 'text/html',
      mermaid: 'text/plain',
      markdown: 'text/markdown',
      svg: 'image/svg+xml',
      code: 'text/plain',
      csv: 'text/csv',
      json: 'application/json',
      text: 'text/plain',
      docx: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    };

    function ArtifactPreview({ artifact }) {
      const iframeRef = useRef(null);
      const [height, setHeight] = useState(300);
      const [copied, setCopied] = useState(false);

      useEffect(() => {
        const handler = (e) => {
          if (e.source !== iframeRef.current?.contentWindow) return;
          if (e.data.type === 'resize') setHeight(Math.max(200, e.data.height + 20));
        };
        window.addEventListener('message', handler);
        return () => window.removeEventListener('message', handler);
      }, []);

      useEffect(() => {
        if (!iframeRef.current || !artifact) return;
        const gen = generators[artifact.type] || generators.html;
        iframeRef.current.srcdoc = gen(artifact.content, artifact.lang);
      }, [artifact]);

      const handleCopy = async () => {
        try {
          await navigator.clipboard.writeText(artifact.content);
          setCopied(true);
          setTimeout(() => setCopied(false), 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      };

      const handleDownload = async () => {
        const ext = fileExtensions[artifact.type] || 'txt';
        const filename = `${artifact.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.${ext}`;

        // Special handling for Word documents - generate real .docx
        if (artifact.type === 'docx' && typeof docx !== 'undefined') {
          try {
            const { Document, Packer, Paragraph, TextRun, HeadingLevel } = docx;

            // Parse content into paragraphs
            const lines = artifact.content.split('\n');
            const children = lines.map(line => {
              // Detect headers
              if (line.startsWith('# ')) {
                return new Paragraph({
                  text: line.slice(2),
                  heading: HeadingLevel.HEADING_1,
                });
              } else if (line.startsWith('## ')) {
                return new Paragraph({
                  text: line.slice(3),
                  heading: HeadingLevel.HEADING_2,
                });
              } else if (line.startsWith('### ')) {
                return new Paragraph({
                  text: line.slice(4),
                  heading: HeadingLevel.HEADING_3,
                });
              }
              return new Paragraph({
                children: [new TextRun(line)],
              });
            });

            const doc = new Document({
              sections: [{
                properties: {},
                children: children,
              }],
            });

            const blob = await Packer.toBlob(doc);
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            return;
          } catch (err) {
            console.error('Failed to generate docx:', err);
          }
        }

        // Default: plain blob download
        const mime = mimeTypes[artifact.type] || 'text/plain';
        const blob = new Blob([artifact.content], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      return (
        <div className="border border-spawn-border rounded-lg overflow-hidden bg-[#0f0f0f]">
          <div className="h-9 bg-spawn-surface flex items-center justify-between px-3 border-b border-spawn-border">
            <div className="flex items-center gap-2">
              <span className="text-xs px-1.5 py-0.5 bg-purple-600/20 text-purple-400 rounded uppercase">{artifact.type}</span>
              <span className="text-sm text-white">{artifact.title}</span>
            </div>
            <div className="flex items-center gap-1">
              <button
                onClick={handleCopy}
                className="p-1.5 hover:bg-spawn-border rounded transition-colors text-spawn-muted hover:text-white"
                title="Copy to clipboard"
              >
                {copied ? (
                  <svg className="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                  </svg>
                ) : (
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                  </svg>
                )}
              </button>
              <button
                onClick={handleDownload}
                className="p-1.5 hover:bg-spawn-border rounded transition-colors text-spawn-muted hover:text-white"
                title="Download file"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
              </button>
            </div>
          </div>
          <iframe ref={iframeRef} className="w-full border-0" style={{ height }} sandbox="allow-scripts allow-same-origin" />
        </div>
      );
    }

    // ==================== Message Components ====================
    function ToolCallDisplay({ tool, args, result }) {
      const [expanded, setExpanded] = useState(false);
      const isSuccess = result?.success !== false;

      return (
        <div className="my-2 border border-spawn-border rounded-lg overflow-hidden bg-spawn-bg/50">
          <button
            onClick={() => setExpanded(!expanded)}
            className="w-full flex items-center justify-between px-3 py-2 hover:bg-spawn-surface/50 transition-colors"
          >
            <div className="flex items-center gap-2">
              <span className={`w-2 h-2 rounded-full ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`} />
              <span className="text-xs font-mono text-purple-400">{tool}</span>
              <span className="text-xs text-spawn-muted truncate max-w-xs">
                {JSON.stringify(args).slice(0, 60)}...
              </span>
            </div>
            <span className="text-spawn-muted">{expanded ? '‚ñº' : '‚ñ∂'}</span>
          </button>
          {expanded && (
            <div className="p-3 border-t border-spawn-border bg-[#0a0a0a]">
              <div className="text-xs text-spawn-muted mb-1">Arguments:</div>
              <pre className="text-xs text-green-400 mb-3 overflow-auto max-h-32">{JSON.stringify(args, null, 2)}</pre>
              <div className="text-xs text-spawn-muted mb-1">Result:</div>
              <pre className="text-xs text-cyan-400 overflow-auto max-h-48">{JSON.stringify(result, null, 2)}</pre>
            </div>
          )}
        </div>
      );
    }

    function Message({ message }) {
      const isUser = message.role === 'user';
      const isSystem = message.role === 'system';

      if (isSystem) return null;

      return (
        <div className="flex gap-3">
          <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 text-sm font-bold ${
            isUser ? 'bg-blue-600' : 'bg-gradient-to-br from-purple-600 to-pink-600'
          }`}>
            {isUser ? 'üë§' : 'A'}
          </div>
          <div className="flex-1 max-w-[80%]">
            <div className={`inline-block rounded-2xl px-4 py-2 ${
              isUser ? 'bg-blue-600 text-white' : 'bg-spawn-surface text-spawn-text'
            }`}>
              {isUser ? (
                <p className="text-sm whitespace-pre-wrap">{message.content}</p>
              ) : (
                <div
                  className="text-sm markdown-content"
                  dangerouslySetInnerHTML={{ __html: window.marked ? window.marked.parse(message.content || '') : message.content }}
                />
              )}
            </div>

            {/* Tool calls */}
            {message.toolCalls?.map((tc, i) => (
              <ToolCallDisplay key={i} {...tc} />
            ))}

            {/* Artifacts */}
            {message.artifacts?.map((artifact, i) => (
              <div key={i} className="mt-3">
                <ArtifactPreview artifact={artifact} />
              </div>
            ))}

            {message.timestamp && (
              <div className="text-xs text-spawn-muted mt-1">
                {new Date(message.timestamp).toLocaleTimeString()}
              </div>
            )}
          </div>
        </div>
      );
    }

    // ==================== GitHub Panel ====================
    function GitHubPanel({ isOpen, onClose, onClone }) {
      const [repoUrl, setRepoUrl] = useState('');
      const [cloningRepo, setCloningRepo] = useState(null); // Track which repo is being cloned
      const [clonedRepos, setClonedRepos] = useState(new Set()); // Track successfully cloned repos
      const [gitStatus, setGitStatus] = useState(null);
      const [gitUser, setGitUser] = useState(null);
      const [githubRepos, setGithubRepos] = useState([]);
      const [localRepos, setLocalRepos] = useState([]);
      const [loading, setLoading] = useState(false);
      const [message, setMessage] = useState('');
      const [activeTab, setActiveTab] = useState('github'); // 'github' or 'local'

      // Refresh local repos list
      const refreshLocalRepos = async () => {
        try {
          const r = await fetch('/api/workspace/files?path=.');
          const data = await r.json();
          // Parse ls -la output: lines starting with 'd' are directories
          const lines = (data.files || '').split('\n').filter(line => line.startsWith('d'));
          const dirs = lines.map(line => {
            // Parse ls -la line: drwxrwxr-x  9 spawn spawn 4096 Dec 10 00:00 dirname
            const parts = line.split(/\s+/);
            const name = parts.slice(8).join(' '); // Directory name (may have spaces)
            return { name, type: 'directory' };
          }).filter(d => d.name && d.name !== '.' && d.name !== '..');
          setLocalRepos(dirs);
          // Update cloned set based on local repos
          const localNames = new Set(dirs.map(d => d.name));
          setClonedRepos(localNames);
        } catch (e) {
          console.error('Failed to refresh local repos:', e);
        }
      };

      useEffect(() => {
        if (isOpen) {
          setLoading(true);
          setMessage('');

          // Check GitHub config
          fetch('/api/git/config')
            .then(r => r.json())
            .then(setGitStatus)
            .catch(() => setGitStatus({ github_token_configured: false }));

          // Get GitHub user info
          fetch('/api/git/user')
            .then(r => r.ok ? r.json() : null)
            .then(setGitUser)
            .catch(() => setGitUser(null));

          // Get GitHub repos
          fetch('/api/git/repos')
            .then(r => r.ok ? r.json() : { repos: [] })
            .then(data => setGithubRepos(data.repos || []))
            .catch(() => setGithubRepos([]))
            .finally(() => setLoading(false));

          // List local repos in workspace and build cloned set
          refreshLocalRepos();
        }
      }, [isOpen]);

      const handleClone = (url, repoName) => {
        const targetUrl = url || repoUrl.trim();
        if (!targetUrl) return;

        // Send to agent - it will clone AND analyze
        onClone(`Clone and analyze ${targetUrl}`);
        setRepoUrl('');
        onClose();
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50" onClick={onClose}>
          <div className="bg-spawn-surface border border-spawn-border rounded-xl w-full max-w-lg p-6" onClick={e => e.stopPropagation()}>
            {/* Header */}
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-3">
                <svg className="w-8 h-8 text-white" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
                </svg>
                <div>
                  <h2 className="text-lg font-bold text-white">GitHub Sync</h2>
                  <div className="flex items-center gap-2">
                    <span className={`w-2 h-2 rounded-full ${gitStatus?.github_token_configured ? 'bg-green-500' : 'bg-red-500'}`} />
                    <span className="text-xs text-spawn-muted">
                      {gitStatus?.github_token_configured ? 'Token configured' : 'No token'}
                    </span>
                  </div>
                </div>
              </div>
              <button onClick={onClose} className="text-spawn-muted hover:text-white">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>

            {/* Clone Section */}
            <div className="mb-6">
              <label className="block text-sm text-spawn-muted mb-2">Clone Repository</label>
              <div className="flex gap-2">
                <input
                  type="text"
                  value={repoUrl}
                  onChange={e => setRepoUrl(e.target.value)}
                  placeholder="https://github.com/user/repo or user/repo"
                  className="flex-1 bg-spawn-bg border border-spawn-border rounded-lg px-3 py-2 text-sm text-white placeholder-spawn-muted focus:outline-none focus:border-purple-600"
                  onKeyDown={e => e.key === 'Enter' && handleClone()}
                />
                <button
                  onClick={() => handleClone()}
                  disabled={cloningRepo || !repoUrl.trim()}
                  className="px-4 py-2 bg-purple-600 hover:bg-purple-500 disabled:opacity-50 text-white rounded-lg text-sm font-medium"
                >
                  {cloningRepo === 'manual' ? 'Cloning...' : 'Clone'}
                </button>
              </div>
              {message && (
                <div className={`mt-2 text-sm ${message.startsWith('Error') ? 'text-red-400' : 'text-green-400'}`}>
                  {message}
                </div>
              )}
            </div>

            {/* Tabs */}
            <div className="flex gap-2 mb-4">
              <button
                onClick={() => setActiveTab('github')}
                className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                  activeTab === 'github' ? 'bg-purple-600 text-white' : 'bg-spawn-bg text-spawn-muted hover:text-white'
                }`}
              >
                GitHub Repos ({githubRepos.length})
              </button>
              <button
                onClick={() => setActiveTab('local')}
                className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                  activeTab === 'local' ? 'bg-purple-600 text-white' : 'bg-spawn-bg text-spawn-muted hover:text-white'
                }`}
              >
                Local ({localRepos.length})
              </button>
            </div>

            {/* GitHub Repos Tab */}
            {activeTab === 'github' && (
              <div>
                <div className="bg-spawn-bg border border-spawn-border rounded-lg max-h-64 overflow-y-auto">
                  {loading ? (
                    <div className="p-4 text-center text-spawn-muted text-sm">Loading repos...</div>
                  ) : githubRepos.length === 0 ? (
                    <div className="p-4 text-center text-spawn-muted text-sm">No repos found. Check token permissions.</div>
                  ) : (
                    githubRepos.map((repo, i) => {
                      const isCloned = clonedRepos.has(repo.name);
                      const isCloning = cloningRepo === repo.name;
                      return (
                        <div key={i} className={`flex items-center justify-between px-3 py-2 border-b border-spawn-border last:border-0 hover:bg-spawn-surface/50 ${isCloned ? 'bg-green-900/10' : ''}`}>
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2">
                              {repo.private ? (
                                <svg className="w-4 h-4 text-yellow-500 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                  <path d="M12 1C8.676 1 6 3.676 6 7v2H4v14h16V9h-2V7c0-3.324-2.676-6-6-6zm0 2c2.276 0 4 1.724 4 4v2H8V7c0-2.276 1.724-4 4-4z"/>
                                </svg>
                              ) : (
                                <svg className="w-4 h-4 text-spawn-muted flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                  <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
                                </svg>
                              )}
                              <span className="text-sm text-white truncate">{repo.name}</span>
                              {repo.language && (
                                <span className="text-xs px-1.5 py-0.5 bg-spawn-border rounded text-spawn-muted">{repo.language}</span>
                              )}
                              {isCloned && (
                                <span className="text-xs px-1.5 py-0.5 bg-green-600/20 text-green-400 rounded">Local</span>
                              )}
                            </div>
                            {repo.description && (
                              <p className="text-xs text-spawn-muted mt-1 truncate">{repo.description}</p>
                            )}
                          </div>
                          {isCloned ? (
                            <div className="ml-2 flex items-center gap-1 text-green-400">
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                              </svg>
                              <span className="text-xs">Cloned</span>
                            </div>
                          ) : (
                            <button
                              type="button"
                              onClick={() => handleClone(repo.clone_url, repo.name)}
                              disabled={cloningRepo !== null}
                              className="ml-2 px-3 py-1 bg-purple-600 hover:bg-purple-500 disabled:opacity-50 text-white text-xs rounded flex-shrink-0 flex items-center gap-1"
                            >
                              {isCloning ? (
                                <>
                                  <svg className="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                  </svg>
                                  <span>Cloning...</span>
                                </>
                              ) : (
                                'Clone'
                              )}
                            </button>
                          )}
                        </div>
                      );
                    })
                  )}
                </div>
              </div>
            )}

            {/* Local Repos Tab */}
            {activeTab === 'local' && (
              <div>
                <div className="bg-spawn-bg border border-spawn-border rounded-lg max-h-64 overflow-y-auto">
                  {localRepos.length === 0 ? (
                    <div className="p-4 text-center text-spawn-muted text-sm">No repositories cloned yet</div>
                  ) : (
                    localRepos.map((repo, i) => (
                      <div key={i} className="flex items-center justify-between px-3 py-2 border-b border-spawn-border last:border-0 hover:bg-spawn-surface/50">
                        <div className="flex items-center gap-2">
                          <svg className="w-4 h-4 text-spawn-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                          </svg>
                          <span className="text-sm text-white">{repo.name}</span>
                        </div>
                        <button
                          onClick={() => {
                            onClose();
                            if (onClone) onClone(`Analyze the ${repo.name} repository - run full protocol`);
                          }}
                          className="text-xs text-purple-400 hover:text-purple-300"
                        >
                          Analyze
                        </button>
                      </div>
                    ))
                  )}
                </div>
              </div>
            )}

            {/* Quick Actions */}
            <div className="mt-6 pt-4 border-t border-spawn-border">
              <div className="flex gap-2">
                <button
                  onClick={() => {
                    onClose();
                    if (onClone) onClone('Show me the git status of the current workspace');
                  }}
                  className="flex-1 px-3 py-2 bg-spawn-bg hover:bg-spawn-border text-spawn-text rounded-lg text-sm"
                >
                  Git Status
                </button>
                <button
                  onClick={() => {
                    onClose();
                    if (onClone) onClone('List all branches in the current repo');
                  }}
                  className="flex-1 px-3 py-2 bg-spawn-bg hover:bg-spawn-border text-spawn-text rounded-lg text-sm"
                >
                  Branches
                </button>
                <button
                  onClick={() => {
                    onClose();
                    if (onClone) onClone('Show recent git commits with details');
                  }}
                  className="flex-1 px-3 py-2 bg-spawn-bg hover:bg-spawn-border text-spawn-text rounded-lg text-sm"
                >
                  Log
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // ==================== Main App ====================
    function App() {
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const [loading, setLoading] = useState(false);
      const [thinking, setThinking] = useState('');
      const [serverStatus, setServerStatus] = useState(null);
      const [showGitHub, setShowGitHub] = useState(false);
      const messagesEndRef = useRef(null);
      const inputRef = useRef(null);

      // Check server health
      useEffect(() => {
        fetch('/health')
          .then(r => r.json())
          .then(setServerStatus)
          .catch(() => setServerStatus({ status: 'offline' }));
      }, []);

      // Handle clone from GitHub panel
      const handleGitHubAction = (prompt) => {
        setInput(prompt);
        setTimeout(() => inputRef.current?.focus(), 100);
      };

      // Auto-scroll
      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages, thinking]);

      // Send message
      const sendMessage = async () => {
        if (!input.trim() || loading) return;

        const userMessage = {
          role: 'user',
          content: input.trim(),
          timestamp: new Date(),
        };

        setMessages(prev => [...prev, userMessage]);
        setInput('');
        setLoading(true);
        setThinking('Thinking...');

        try {
          // Use streaming endpoint
          const response = await fetch('/api/chat/stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message: userMessage.content,
              history: messages.slice(-10).map(m => ({ role: m.role, content: m.content })),
            }),
          });

          const reader = response.body.getReader();
          const decoder = new TextDecoder();

          let assistantMessage = {
            role: 'assistant',
            content: '',
            toolCalls: [],
            artifacts: [],
            timestamp: new Date(),
          };

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n').filter(l => l.startsWith('data: '));

            for (const line of lines) {
              try {
                const data = JSON.parse(line.slice(6));

                switch (data.type) {
                  case 'thinking':
                    setThinking(`Thinking... (step ${data.iteration})`);
                    break;
                  case 'tool_start':
                    setThinking(`Running ${data.tool}...`);
                    // Store args from tool_start for pairing with result
                    assistantMessage._pendingTool = { tool: data.tool, args: data.args };
                    break;
                  case 'tool_result':
                    assistantMessage.toolCalls.push({
                      tool: data.tool,
                      args: assistantMessage._pendingTool?.args || {},
                      result: data.result,
                    });
                    // Update message in place
                    setMessages(prev => {
                      const updated = [...prev];
                      const lastIdx = updated.length - 1;
                      if (updated[lastIdx]?.role === 'assistant') {
                        updated[lastIdx] = { ...assistantMessage };
                      } else {
                        updated.push({ ...assistantMessage });
                      }
                      return updated;
                    });
                    break;
                  case 'artifact':
                    assistantMessage.artifacts.push(data.artifact);
                    setMessages(prev => {
                      const updated = [...prev];
                      if (updated[updated.length - 1]?.role === 'assistant') {
                        updated[updated.length - 1] = { ...assistantMessage };
                      }
                      return updated;
                    });
                    break;
                  case 'response':
                    assistantMessage.content = data.content;
                    setMessages(prev => {
                      const updated = [...prev];
                      const lastIdx = updated.length - 1;
                      if (updated[lastIdx]?.role === 'assistant') {
                        updated[lastIdx] = { ...assistantMessage };
                      } else {
                        updated.push({ ...assistantMessage });
                      }
                      return updated;
                    });
                    break;
                  case 'done':
                    setThinking('');
                    break;
                  case 'error':
                    setThinking('');
                    assistantMessage.content = `Error: ${data.message}`;
                    setMessages(prev => [...prev, { ...assistantMessage }]);
                    break;
                }
              } catch {}
            }
          }

          // Ensure final message is added
          if (assistantMessage.content || assistantMessage.toolCalls.length || assistantMessage.artifacts.length) {
            setMessages(prev => {
              const updated = [...prev];
              const lastIdx = updated.length - 1;
              if (updated[lastIdx]?.role !== 'assistant') {
                updated.push({ ...assistantMessage });
              }
              return updated;
            });
          }

        } catch (err) {
          setMessages(prev => [...prev, {
            role: 'assistant',
            content: `Error: ${err.message}`,
            timestamp: new Date(),
          }]);
        } finally {
          setLoading(false);
          setThinking('');
          inputRef.current?.focus();
        }
      };

      const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      };

      return (
        <div className="h-screen flex justify-center bg-spawn-bg">
          <div className="w-full max-w-2xl flex flex-col border-x border-spawn-border">
          {/* Header */}
          <header className="h-14 border-b border-spawn-border flex items-center justify-between px-4 bg-spawn-surface flex-shrink-0">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center text-xl font-bold">
                A
              </div>
              <div>
                <span className="font-bold text-white text-lg">ARCHITECT</span>
                <div className="flex items-center gap-2">
                  <span className="text-xs text-spawn-muted">AI Development Agent</span>
                  <span className="text-xs px-1.5 py-0.5 rounded bg-purple-600/20 text-purple-400">v2.0</span>
                </div>
              </div>
            </div>
            <div className="flex items-center gap-4">
              <div className="text-xs text-spawn-muted">
                {serverStatus?.workspace ? `üìÇ ${serverStatus.workspace.split('/').pop()}` : ''}
              </div>
              {/* GitHub Button */}
              <button
                type="button"
                onClick={(e) => { e.preventDefault(); e.stopPropagation(); setShowGitHub(true); }}
                className="flex items-center gap-2 px-3 py-1.5 bg-purple-600 hover:bg-purple-500 text-white rounded-lg transition-colors cursor-pointer"
                title="Open GitHub Sync Panel"
              >
                <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
                </svg>
                <span className="text-xs font-medium">Sync</span>
              </button>
              <div className="flex items-center gap-2">
                <div className={`w-2 h-2 rounded-full ${serverStatus?.status === 'healthy' ? 'bg-green-500' : 'bg-red-500'}`} />
                <span className="text-xs text-spawn-muted">{serverStatus?.status || 'Checking...'}</span>
              </div>
            </div>
          </header>

          {/* GitHub Panel Modal */}
          <GitHubPanel
            isOpen={showGitHub}
            onClose={() => setShowGitHub(false)}
            onClone={handleGitHubAction}
          />

          {/* Messages */}
          <div className="flex-1 overflow-auto p-4 space-y-4">
            {messages.length === 0 && (
              <div className="text-center py-12">
                <div className="text-5xl mb-4">üèóÔ∏è</div>
                <h2 className="text-2xl font-bold text-white mb-2">ARCHITECT</h2>
                <p className="text-spawn-muted max-w-lg mx-auto mb-2">
                  Elite AI Development Agent with full sandbox access.
                </p>
                <p className="text-spawn-muted/70 text-sm max-w-lg mx-auto">
                  I execute commands, write code, create visual artifacts, and use persistent terminals.
                  I follow the OODA loop: Observe ‚Üí Orient ‚Üí Decide ‚Üí Act
                </p>
                <div className="mt-6 flex flex-wrap gap-2 justify-center max-w-2xl mx-auto">
                  {[
                    'Clone and analyze github.com/user/repo - full protocol',
                    'Create a React todo app with local storage',
                    'Build a dashboard with charts using Recharts',
                    'Create a mermaid diagram of this architecture',
                    'Show me what tools you have available',
                  ].map((prompt, i) => (
                    <button
                      key={i}
                      onClick={() => { setInput(prompt); inputRef.current?.focus(); }}
                      className="px-3 py-1.5 bg-spawn-surface hover:bg-spawn-border text-sm text-spawn-text rounded-lg transition-colors"
                    >
                      {prompt}
                    </button>
                  ))}
                </div>
              </div>
            )}

            {messages.map((msg, i) => (
              <Message key={i} message={msg} />
            ))}

            {thinking && (
              <div className="flex gap-3">
                <div className="w-8 h-8 rounded-full bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center flex-shrink-0 text-sm font-bold">
                  A
                </div>
                <div className="bg-spawn-surface rounded-2xl px-4 py-2">
                  <p className="text-sm text-spawn-muted typing-cursor">{thinking}</p>
                </div>
              </div>
            )}

            <div ref={messagesEndRef} />
          </div>

          {/* Input */}
          <div className="border-t border-spawn-border p-4 bg-spawn-surface flex-shrink-0">
            <div className="flex gap-3 max-w-4xl mx-auto">
              <textarea
                ref={inputRef}
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyDown={handleKeyDown}
                placeholder="Ask ARCHITECT to build something..."
                className="flex-1 bg-spawn-bg border border-spawn-border rounded-xl px-4 py-3 text-sm text-white placeholder-spawn-muted resize-none focus:outline-none focus:border-purple-600 transition-colors"
                rows={2}
                disabled={loading}
              />
              <button
                onClick={sendMessage}
                disabled={loading || !input.trim()}
                className="px-6 bg-purple-600 hover:bg-purple-500 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-xl font-medium transition-colors"
              >
                {loading ? '...' : 'Send'}
              </button>
            </div>
            <div className="text-xs text-spawn-muted text-center mt-2">
              Press Enter to send, Shift+Enter for new line
            </div>
          </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
